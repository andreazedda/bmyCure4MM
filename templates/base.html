{% load static simulator_extras %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MM Portal</title>
    <link rel="icon" href="{% static 'img/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'app/ui-guardrails.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand fw-semibold" href="{% url 'clinic:dashboard' %}">MM Portal</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                {% simulator_is_editor request.user as user_is_simulator_editor %}
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="{% url 'clinic:dashboard' %}">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'clinic:patient_list' %}">Patients</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'chemtools:tools_home' %}">Chem Tools</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'simulator:scenario_list' %}">Simulator</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'docs' %}">Docs</a></li>
                    {% if request.user.is_authenticated and user_is_simulator_editor %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="manageMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Manage
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="manageMenu">
                                <li><a class="dropdown-item" href="{% url 'simulator:scenario_manage_list' %}">Scenarios</a></li>
                                <li><a class="dropdown-item" href="{% url 'simulator:regimen_list' %}">Regimens</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'simulator:experiments' %}">
                                    <i class="bi bi-graph-up"></i> Optimization Lab
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'simulator:cohort' %}">
                                    <i class="bi bi-people-fill"></i> Virtual Cohort
                                </a></li>
                            </ul>
                        </li>
                    {% endif %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'admin:index' %}">Admin</a></li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    {% if request.user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                {{ request.user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li><a class="dropdown-item" href="{% url 'admin:logout' %}">Log out</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'admin:login' %}">Log in</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4 sticky-offset">
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    {% with level_class=message.tags %}
                        {% if message.level_tag == 'error' %}
                            {% with 'danger' as level_class %}
                                <div class="alert alert-{{ level_class }} alert-dismissible fade show" role="alert">
                                    {{ message|upper }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endwith %}
                        {% else %}
                            <div class="alert alert-{{ level_class|default:'info' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>
        {% endif %}
        <!-- Accessibility live region for screen readers -->
        <div id="live-region" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>
        <div class="d-flex align-items-center gap-2 mb-2">
            <div class="btn-group btn-group-sm" role="group" aria-label="Language">
                <button type="button" class="btn btn-outline-secondary" data-lang="en" id="lang-en">EN</button>
                <button type="button" class="btn btn-outline-secondary" data-lang="it" id="lang-it">IT</button>
            </div>
            <div class="form-check form-switch ms-3">
                <input class="form-check-input" type="checkbox" id="novice-mode" checked>
                <label class="form-check-label" for="novice-mode">
                    Novice Mode
                </label>
            </div>
        </div>
        <script>
          (function(){
            const langButtons = {
              en: document.getElementById('lang-en'),
              it: document.getElementById('lang-it'),
            };
            const setActiveLang = (lang) => {
              document.documentElement.setAttribute('data-lang', lang);
              document.documentElement.lang = lang;
              Object.entries(langButtons).forEach(([key, btn]) => {
                if (!btn) return;
                if (key === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
              });
              document.dispatchEvent(new CustomEvent('language-changed', { detail: { lang } }));
            };
            window.setActiveLang = setActiveLang;
            if (langButtons.en) {
              langButtons.en.onclick = () => setActiveLang('en');
            }
            if (langButtons.it) {
              langButtons.it.onclick = () => setActiveLang('it');
            }
            setActiveLang('en');
            document.documentElement.setAttribute('data-novice','');
          })();
        </script>
        <style>
          [data-lang="en"] .t-it { display:none !important; }
          [data-lang="it"] .t-en { display:none !important; }
          html[data-novice] .novice-tip { display:block; }
          .novice-tip { display:none; font-size:0.92rem; }
          .tour-highlight { outline: 3px solid #0d6efd; outline-offset: 2px; border-radius: 8px; transition: outline-color 0.2s; }
          .help-inline { color: var(--bs-primary); text-decoration: underline dotted; }
          .help-inline:hover,
          .help-inline:focus { color: var(--bs-primary); text-decoration: underline; }
        </style>
        <script>
          window.getCurrentLang = window.getCurrentLang || function () {
              return document.documentElement.getAttribute('data-lang') || 'en';
          };
        </script>
        <script>
          document.documentElement.lang = document.documentElement.getAttribute('data-lang') || 'en';
        </script>
        {% block content %}{% endblock %}
    </div>

    <footer class="bg-white border-top py-3">
        <div class="container">
            <p class="mb-0 text-muted small text-center">
                This portal provides clinical decision support. It is not a diagnostic device. Validate outputs with clinical judgment and institutional guidelines.
            </p>
        </div>
    </footer>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
        <div id="toast-status" class="toast align-items-center text-bg-secondary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message">Working‚Ä¶</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    <!-- Contextual Help Drawer -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="helpDrawer" data-testid="help-drawer" aria-labelledby="helpDrawerLabel">
        <div class="offcanvas-header">
            <h5 id="helpDrawerLabel">Help</h5>
            <div class="btn-group btn-group-sm me-2" role="group" aria-label="Help language">
                <button type="button" class="btn btn-outline-secondary" onclick="setHelpLang('en')">EN</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setHelpLang('it')">IT</button>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="helpDrawerContent" class="small text-body"></div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="Tour.prev()">‚Äπ</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="Tour.next()">‚Ä∫</button>
            </div>
        </div>
    </div>
    <div id="tourOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none" style="z-index:1080"></div>
    <div id="cmdkWrapper">
        <input id="cmdk" data-testid="cmdk-input" class="form-control d-none position-fixed top-10 start-50 translate-middle-x" style="z-index:1090; width:480px;" placeholder="Type to search help‚Ä¶" autocomplete="off" />
        <div id="cmdkList" class="position-fixed top-25 start-50 translate-middle-x bg-white shadow rounded d-none" style="z-index:1090; width:480px; max-height:60vh; overflow:auto;">
            <div id="cmdkResults" class="list-group list-group-flush"></div>
        </div>
    </div>

    <script src="{% static 'app/js/badges.js' %}"></script>
    <script src="{% static 'app/js/sandbox-hints.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script>
    const getCurrentLang = () => document.documentElement.getAttribute('data-lang') || 'en';
    const live = (msg) => {
        const node = document.getElementById('live-region');
        if (node) {
            node.textContent = '';
            setTimeout(() => { node.textContent = msg; }, 0);
        }
    };
    window.updateLive = live;
    const showToast = (msg, variant='secondary') => {
        const toastEl = document.getElementById('toast-status');
        if (!toastEl || typeof bootstrap === 'undefined') {
            return;
        }
        toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
        const body = document.getElementById('toast-message');
        if (body) {
            body.textContent = msg;
        }
        const toast = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2500 });
        toast.show();
    };

    const HELP_CACHE = new Map();
    let helpDrawerLang = getCurrentLang();
    let currentHelpSlug = null;
    const helpDrawerEl = document.getElementById('helpDrawer');
    const helpDrawerLabel = document.getElementById('helpDrawerLabel');
    const helpDrawerContent = document.getElementById('helpDrawerContent');
    const tourOverlay = document.getElementById('tourOverlay');
    const cmdInput = document.getElementById('cmdk');
    const cmdList = document.getElementById('cmdkList');
    const cmdResults = document.getElementById('cmdkResults');
    let cmdOpen = false;
    let lastHelpTrigger = null;
    let releaseHelpTrap = null;
    const CMD_TYPE_ICONS = {
        article: 'üìò',
        field: 'üéØ',
        preset: 'üß™',
        kpi: 'üìà',
    };
    const GLOSSARY = {
        // üéØ Disease Staging & Risk Assessment
        riss: {
            en: 'üéØ R-ISS Stage (I‚ÄìIII): Think of it as a "difficulty level" for the disease. Stage I is "easier to treat" (like tutorial mode), Stage III is "advanced" (hard mode). Combines Œ≤2M, albumin, LDH and genetics to predict prognosis.',
            it: 'üéØ Stadio R-ISS (I‚ÄìIII): Pensalo come un "livello di difficolt√†" della malattia. Stadio I √® "pi√π facile da trattare" (modalit√† tutorial), Stadio III √® "avanzato" (modalit√† difficile). Combina Œ≤2M, albumina, LDH e genetica per predire la prognosi.',
        },
        
        // üìä Biomarkers - "Health Meters"
        ldh: {
            en: 'üìä LDH (Lactate Dehydrogenase): Imagine it as an "alarm bell" üîî. High LDH = tumor cells are very active and aggressive. Normal range: 140-280 U/L. Think of it like a speedometer showing how fast the disease is "driving".',
            it: 'üìä LDH (Lattato Deidrogenasi): Immaginalo come una "campana d\'allarme" üîî. LDH alto = le cellule tumorali sono molto attive e aggressive. Range normale: 140-280 U/L. Pensalo come un tachimetro che mostra quanto veloce la malattia sta "correndo".',
        },
        b2m: {
            en: 'üìä Œ≤2M (Beta-2 Microglobulin): Your "tumor load gauge" üìà. Higher values = more cancer cells present. Also indicates kidney function. Like a fuel gauge, but for cancer cells. Normal: <3.5 mg/L.',
            it: 'üìä Œ≤2M (Beta-2 Microglobulina): Il tuo "indicatore di carico tumorale" üìà. Valori pi√π alti = pi√π cellule cancerose presenti. Indica anche la funzione renale. Come un indicatore di carburante, ma per le cellule cancerose. Normale: <3.5 mg/L.',
        },
        flc: {
            en: 'üìä FLC Ratio (Œ∫/Œª): The "balance meter" ‚öñÔ∏è of proteins. Normal is ~1.0. Imbalanced? Cancer cells are producing abnormal proteins. Think of it like checking if your recipe has the right ingredient proportions.',
            it: 'üìä Rapporto FLC (Œ∫/Œª): Il "metro di equilibrio" ‚öñÔ∏è delle proteine. Normale √® ~1.0. Sbilanciato? Le cellule cancerose stanno producendo proteine anomale. Pensalo come verificare se la tua ricetta ha le giuste proporzioni degli ingredienti.',
        },
        
        // üíä Pharmacology Concepts
        auc: {
            en: 'üíä AUC (Area Under Curve): Total drug exposure over time ‚è±Ô∏è. Think of it like "total sunshine hours" in a day. Higher AUC = more drug effect, but also more side effects. It\'s about finding the sweet spot! üéØ',
            it: 'üíä AUC (Area Sotto la Curva): Esposizione totale al farmaco nel tempo ‚è±Ô∏è. Pensalo come le "ore totali di sole" in un giorno. AUC pi√π alto = pi√π effetto del farmaco, ma anche pi√π effetti collaterali. Si tratta di trovare il punto giusto! üéØ',
        },
        nadir: {
            en: 'üé¢ Nadir: The "lowest valley" in the tumor burden curve. Like the lowest point on a rollercoaster üé¢ before going back up. It\'s our goal - make the tumor as small as possible before it tries to regrow.',
            it: 'üé¢ Nadir: La "valle pi√π bassa" nella curva del carico tumorale. Come il punto pi√π basso su una montagna russa üé¢ prima di risalire. √à il nostro obiettivo - rendere il tumore il pi√π piccolo possibile prima che provi a ricrescere.',
        },
        
        // üè• Patient Parameters
        creatinine: {
            en: 'üè• Creatinine Clearance: Your "kidney power meter" üí™. Measures how well kidneys filter waste. >60 = good, <30 = weak kidneys (need dose adjustments!). Like checking engine oil before a race.',
            it: 'üè• Clearance della Creatinina: Il tuo "metro di potenza renale" üí™. Misura quanto bene i reni filtrano i rifiuti. >60 = buono, <30 = reni deboli (serve aggiustare le dosi!). Come controllare l\'olio del motore prima di una gara.',
        },
        anc: {
            en: 'üõ°Ô∏è ANC (Absolute Neutrophil Count): Your "immune defense force" üõ°Ô∏è. Neutrophils are like soldiers fighting infections. <500 = dangerously low (infection risk!). >1500 = safe zone. Keep your army strong!',
            it: 'üõ°Ô∏è ANC (Conta Assoluta dei Neutrofili): La tua "forza di difesa immunitaria" üõ°Ô∏è. I neutrofili sono come soldati che combattono le infezioni. <500 = pericolosamente basso (rischio infezioni!). >1500 = zona sicura. Mantieni forte il tuo esercito!',
        },
        platelets: {
            en: 'ü©π Platelets: Your "repair crew" üîß. They stop bleeding and fix injuries. <50k = high bleeding risk. >100k = safe. Like having enough workers to fix road damages quickly.',
            it: 'ü©π Piastrine: La tua "squadra di riparazione" üîß. Fermano i sanguinamenti e riparano le lesioni. <50k = alto rischio emorragico. >100k = sicuro. Come avere abbastanza operai per riparare i danni stradali velocemente.',
        },
        neuropathy: {
            en: '‚ö° Neuropathy Grade: "Nerve damage level" üéÆ. Grade 0 = no damage (perfect!), Grade 4 = severe (can\'t move). Some drugs damage nerves like overheating a circuit board. Monitor carefully!',
            it: '‚ö° Grado di Neuropatia: "Livello di danno nervoso" üéÆ. Grado 0 = nessun danno (perfetto!), Grado 4 = grave (impossibile muoversi). Alcuni farmaci danneggiano i nervi come surriscaldare un circuito. Monitora attentamente!',
        },
        
        // üíâ Drug Mechanisms
        lenalidomide: {
            en: 'üíâ Lenalidomide: The "immune booster" üöÄ. Wakes up your immune system to attack cancer cells AND directly kills them. Oral pill, easier than injections! Dose: 5-25 mg/day. Main risk: low blood counts.',
            it: 'üíâ Lenalidomide: Il "potenziatore immunitario" üöÄ. Sveglia il tuo sistema immunitario per attaccare le cellule cancerose E le uccide direttamente. Pillola orale, pi√π facile delle iniezioni! Dose: 5-25 mg/die. Rischio principale: conta sanguigna bassa.',
        },
        bortezomib: {
            en: 'üíâ Bortezomib: The "protein shredder" ‚úÇÔ∏è. Blocks proteasomes (cancer\'s recycling centers), making cells die from their own garbage. Injection 1-2x/week. Watch out for nerve damage (neuropathy)!',
            it: 'üíâ Bortezomib: Il "tritaproteine" ‚úÇÔ∏è. Blocca i proteasomi (centri di riciclaggio del cancro), facendo morire le cellule dai loro stessi rifiuti. Iniezione 1-2 volte/settimana. Attenzione al danno nervoso (neuropatia)!',
        },
        daratumumab: {
            en: 'üíâ Daratumumab: The "guided missile" üéØ. Antibody that specifically targets CD38 on cancer cells. IV infusion. Very effective but takes hours to infuse. Like sending special forces vs. carpet bombing.',
            it: 'üíâ Daratumumab: Il "missile guidato" üéØ. Anticorpo che colpisce specificamente CD38 sulle cellule cancerose. Infusione IV. Molto efficace ma richiede ore per l\'infusione. Come inviare forze speciali vs. bombardamento a tappeto.',
        },
        
        // üéÆ Simulation Parameters
        tumor_cells: {
            en: 'üéÆ Tumor Cells: The "enemy army size" üëæ. Starting number of cancer cells. Higher = harder challenge. Range: 1M to 1B cells. Your goal: reduce this number as much as possible!',
            it: 'üéÆ Cellule Tumorali: La "dimensione dell\'esercito nemico" üëæ. Numero iniziale di cellule cancerose. Pi√π alto = sfida pi√π difficile. Range: 1M a 1B cellule. Il tuo obiettivo: ridurre questo numero il pi√π possibile!',
        },
        healthy_cells: {
            en: 'üéÆ Healthy Cells: Your "health bar" ‚ù§Ô∏è. Normal bone marrow cells we want to protect. Keep above 50% to avoid complications! Balance is key - kill cancer, protect healthy.',
            it: 'üéÆ Cellule Sane: La tua "barra della salute" ‚ù§Ô∏è. Cellule normali del midollo osseo che vogliamo proteggere. Mantieni sopra il 50% per evitare complicazioni! L\'equilibrio √® la chiave - uccidi il cancro, proteggi le sane.',
        },
        interaction_strength: {
            en: 'üéÆ Drug Interaction: How much drugs "interfere" with each other ‚ö†Ô∏è. 0.0 = no interaction (safe), 0.5 = strong interaction (danger!). Like mixing chemicals - sometimes they amplify effects.',
            it: 'üéÆ Interazione Farmaci: Quanto i farmaci "interferiscono" tra loro ‚ö†Ô∏è. 0.0 = nessuna interazione (sicuro), 0.5 = forte interazione (pericolo!). Come mescolare sostanze chimiche - a volte amplificano gli effetti.',
        },
        time_horizon: {
            en: '‚è∞ Time Horizon: Your "campaign duration" üìÖ. How many days to simulate treatment? 30 days = short (preview), 365 days = full year (complete picture). Longer = see full cycle of response.',
            it: '‚è∞ Orizzonte Temporale: La "durata della campagna" üìÖ. Quanti giorni simulare il trattamento? 30 giorni = breve (anteprima), 365 giorni = anno completo (quadro completo). Pi√π lungo = vedi il ciclo completo della risposta.',
        },
        
        // üèÜ Success Metrics
        response_rate: {
            en: 'üèÜ Response Rate: Your "success score" üéØ. % of tumor reduction. >90% = excellent response! 50-90% = partial response. <50% = minimal response. Aim for the high score!',
            it: 'üèÜ Tasso di Risposta: Il tuo "punteggio di successo" üéØ. % di riduzione tumorale. >90% = risposta eccellente! 50-90% = risposta parziale. <50% = risposta minima. Punta al punteggio alto!',
        },
        toxicity: {
            en: '‚ö†Ô∏è Toxicity: The "side effect level" üíä. Grade 1-2 = mild (manageable), Grade 3-4 = severe (hospitalization risk). Like video game damage - don\'t let it get too high!',
            it: '‚ö†Ô∏è Tossicit√†: Il "livello di effetti collaterali" üíä. Grado 1-2 = lieve (gestibile), Grado 3-4 = grave (rischio ospedalizzazione). Come il danno nei videogiochi - non lasciare che salga troppo!',
        },
    };

    const getCsrfToken = () => {
        const name = 'csrftoken=';
        const decoded = document.cookie ? decodeURIComponent(document.cookie) : '';
        const cookies = decoded.split(';');
        for (const cookie of cookies) {
            const c = cookie.trim();
            if (c.startsWith(name)) {
                return c.substring(name.length);
            }
        }
        return '';
    };

    const applyGlossaryTooltips = (root) => {
        const context = root || document;
        const lang = getCurrentLang();
        context.querySelectorAll('[data-gkey]').forEach((el) => {
            const key = el.getAttribute('data-gkey');
            const entry = GLOSSARY[key];
            if (!entry) {
                return;
            }
            const text = entry[lang] || entry.en || '';
            if (text) {
                el.setAttribute('title', text);
                el.setAttribute('aria-label', text);
            }
        });
    };

    const audit = (event, detail) => {
        const token = getCsrfToken();
        fetch('/api/ux/audit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'X-CSRFToken': token } : {}),
            },
            body: JSON.stringify({ event, detail, ts: Date.now() }),
        }).catch(() => {});
    };

    const helpCacheKey = (slug, lang) => `${slug}:${lang}`;
    const fetchHelp = async (slug, lang) => {
        const key = helpCacheKey(slug, lang);
        if (HELP_CACHE.has(key)) {
            return HELP_CACHE.get(key);
        }
        const res = await fetch(`/api/help/${slug}/?lang=${lang}`);
        if (!res.ok) {
            throw new Error('help-not-found');
        }
        const data = await res.json();
        HELP_CACHE.set(key, data);
        return data;
    };

    const openHelp = async (slug) => {
        if (!slug) {
            return;
        }
        currentHelpSlug = slug;
        helpDrawerLang = getCurrentLang() || helpDrawerLang;
        audit('help_open', { slug });
        try {
            const data = await fetchHelp(slug, helpDrawerLang);
            if (helpDrawerLabel) {
                helpDrawerLabel.textContent = data.title;
            }
            if (helpDrawerContent) {
                helpDrawerContent.innerHTML = data.body;
                applyGlossaryTooltips(helpDrawerContent);
            }
            if (helpDrawerEl) {
                bootstrap.Offcanvas.getOrCreateInstance(helpDrawerEl).show();
            }
        } catch (error) {
            const message = helpDrawerLang === 'it' ? 'Voce help non trovata' : 'Help not found';
            showToast(message, 'danger');
        }
    };
    window.openHelp = openHelp;

    const setHelpLang = (lang) => {
        helpDrawerLang = lang;
        if (typeof window.setActiveLang === 'function') {
            window.setActiveLang(lang);
        } else {
            document.documentElement.setAttribute('data-lang', lang);
            document.documentElement.lang = lang;
        }
        if (currentHelpSlug) {
            openHelp(currentHelpSlug);
        }
    };
    window.setHelpLang = setHelpLang;

    const trapFocus = (container) => {
        const selector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
        const focusable = Array.from(container.querySelectorAll(selector)).filter(
            (el) => !el.hasAttribute('disabled') && el.offsetParent !== null
        );
        if (!focusable.length) {
            return () => {};
        }
        let first = focusable[0];
        let last = focusable[focusable.length - 1];
        const handler = (event) => {
            if (event.key !== 'Tab') {
                return;
            }
            if (event.shiftKey) {
                if (document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                }
            } else if (document.activeElement === last) {
                event.preventDefault();
                first.focus();
            }
        };
        container.addEventListener('keydown', handler);
        return () => container.removeEventListener('keydown', handler);
    };

    document.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-help]');
        if (trigger) {
            event.preventDefault();
            lastHelpTrigger = trigger;
            openHelp(trigger.getAttribute('data-help'));
        }
        const auditTarget = event.target.closest('[data-audit]');
        if (auditTarget) {
            audit(auditTarget.getAttribute('data-audit'), {});
        }
    });

    const highlightElement = (selector) => {
        document.querySelectorAll('.tour-highlight').forEach((el) => el.classList.remove('tour-highlight'));
        const el = document.querySelector(selector);
        if (el) {
            el.classList.add('tour-highlight');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    const Tour = {
        step: 0,
        steps: [
            { slug: 'quickstart', highlight: '#simulation-parameters-form' },
            { slug: 'twin', highlight: '#simulation-parameters-form input#id_use_twin' },
            { slug: 'creatinine_clearance', highlight: '#id_creatinine_clearance' },
            { slug: 'neuropathy_grade', highlight: '#id_neuropathy_grade' },
            { slug: 'dose_ranges_lenalidomide', highlight: '#id_lenalidomide_dose' },
            { slug: 'dose_ranges_bortezomib', highlight: '#id_bortezomib_dose' },
            { slug: 'dose_ranges_daratumumab', highlight: '#id_daratumumab_dose' },
            { slug: 'time_horizon', highlight: '#id_time_horizon' },
            { slug: 'cohort_size', highlight: '#id_cohort_size' },
            { slug: 'optimization_lab', highlight: '.novice-submit.btn-outline-primary' },
        ],
        open() {
            this.step = 0;
            if (tourOverlay) {
                tourOverlay.classList.remove('d-none');
                tourOverlay.setAttribute('aria-hidden', 'false');
            }
            this.show();
            audit('tour_start', { step: this.step });
        },
        close() {
            if (tourOverlay) {
                tourOverlay.classList.add('d-none');
                tourOverlay.setAttribute('aria-hidden', 'true');
            }
            document.querySelectorAll('.tour-highlight').forEach((el) => el.classList.remove('tour-highlight'));
            audit('tour_close', { step: this.step });
        },
        show() {
            const current = this.steps[this.step];
            if (!current) {
                this.close();
                return;
            }
            openHelp(current.slug);
            highlightElement(current.highlight);
        },
        next() {
            this.step += 1;
            audit('tour_step', { step: this.step });
            if (this.step >= this.steps.length) {
                this.close();
            } else {
                this.show();
            }
        },
        prev() {
            this.step = Math.max(0, this.step - 1);
            audit('tour_step', { step: this.step });
            this.show();
        },
    };
    window.Tour = Tour;
    if (tourOverlay) {
        tourOverlay.setAttribute('aria-hidden', 'true');
        tourOverlay.addEventListener('click', () => Tour.close());
    }

    const scrollToField = (selector, helpSlug) => {
        const target = document.querySelector(selector);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('tour-highlight');
            setTimeout(() => target.classList.remove('tour-highlight'), 1500);
        }
        if (helpSlug) {
            openHelp(helpSlug);
        }
    };
    window.scrollToField = scrollToField;

    const toggleCmd = (open) => {
        cmdOpen = open === undefined ? !cmdOpen : open;
        if (!cmdInput || !cmdList) {
            return;
        }
        cmdInput.classList.toggle('d-none', !cmdOpen);
        cmdList.classList.toggle('d-none', !cmdOpen);
        if (cmdOpen) {
            cmdInput.value = '';
            cmdInput.focus();
            renderCmd('');
        }
    };

    const renderCmd = async (query) => {
        if (!cmdResults) {
            return;
        }
        const lang = getCurrentLang() || 'en';
        const res = await fetch(`/api/help/search/?q=${encodeURIComponent(query)}&lang=${lang}`);
        const data = await res.json();
        cmdResults.innerHTML = data.results
            .map((item) => {
                const icon = CMD_TYPE_ICONS[item.type] || CMD_TYPE_ICONS.article;
                return `<a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-2" data-help="${item.slug}"><span>${icon}</span><span>${item.title}</span></a>`;
            })
            .join('');
    };

    document.addEventListener('keydown', (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'k') {
            event.preventDefault();
            toggleCmd(true);
        } else if (cmdOpen && event.key === 'Escape') {
            toggleCmd(false);
        }
    });

    document.addEventListener('input', (event) => {
        if (event.target === cmdInput) {
            renderCmd(event.target.value);
        }
    });

    document.addEventListener('click', (event) => {
        if (cmdOpen && cmdList && !cmdList.contains(event.target) && event.target !== cmdInput && !event.target.closest('#cmdkWrapper')) {
            toggleCmd(false);
        }
    });

    document.body.addEventListener('htmx:beforeRequest', () => {
        const message = getCurrentLang() === 'it' ? 'Simulazione in corso‚Ä¶' : 'Running simulation‚Ä¶';
        showToast(message, 'secondary');
    });
    document.body.addEventListener('htmx:responseError', () => {
        const message = getCurrentLang() === 'it' ? 'Errore nella simulazione' : 'Simulation error';
        showToast(message, 'danger');
    });
    document.body.addEventListener('htmx:afterOnLoad', () => {
        const message = getCurrentLang() === 'it' ? 'Completato' : 'Completed';
        showToast(message, 'success');
    });

    document.addEventListener('language-changed', () => applyGlossaryTooltips());

    if (helpDrawerEl) {
        helpDrawerEl.setAttribute('role', 'dialog');
        helpDrawerEl.setAttribute('aria-modal', 'true');
        helpDrawerEl.addEventListener('shown.bs.offcanvas', () => {
            if (releaseHelpTrap) {
                releaseHelpTrap();
            }
            releaseHelpTrap = trapFocus(helpDrawerEl);
            const focusable = helpDrawerEl.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            (focusable || helpDrawerEl).focus();
        });
        helpDrawerEl.addEventListener('hidden.bs.offcanvas', () => {
            if (releaseHelpTrap) {
                releaseHelpTrap();
            }
            if (lastHelpTrigger) {
                lastHelpTrigger.focus();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const offcanvasTriggers = document.querySelectorAll('[data-bs-toggle="offcanvas"]');
        offcanvasTriggers.forEach((trigger) => {
            trigger.addEventListener('click', () => {
                const active = document.querySelector('.offcanvas.show');
                if (active) {
                    const existing = bootstrap.Offcanvas.getInstance(active);
                    if (existing) {
                        existing.hide();
                    }
                }
            });
        });

        const noviceToggle = document.getElementById('novice-mode');
        if (noviceToggle) {
            noviceToggle.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.documentElement.setAttribute('data-novice', '');
                } else {
                    document.documentElement.removeAttribute('data-novice');
                }
                audit('novice_toggle', { enabled: e.target.checked });
            });
        }

        document.body.addEventListener('htmx:afterRequest', (event) => {
            const detail = event.detail;
            if (!detail || !detail.pathInfo) {
                return;
            }
            const path = detail.pathInfo.path || '';
            const matchers = [
                { name: 'chemtools', regex: /chemtools\/job\/\d+\/status\.json$/ },
                { name: 'simulator', regex: /sim\/scenarios\/\d+\/simulate\/$/ },
            ];
            detail.mmMatchedPath = null;
            for (const matcher of matchers) {
                if (matcher.regex.test(path)) {
                    detail.mmMatchedPath = matcher.name;
                    break;
                }
            }
            if (!detail.mmMatchedPath || !detail.xhr) {
                return;
            }
            if (detail.mmMatchedPath === 'chemtools') {
                try {
                    detail.mmParsedJson = JSON.parse(detail.xhr.responseText);
                } catch (error) {
                    detail.mmParsedJson = null;
                }
            }
        });

        const initTooltips = () => {
            const tooltipTriggerList = Array.prototype.slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach((el) => new bootstrap.Tooltip(el));
        };
        initTooltips();
        applyGlossaryTooltips();
        document.body.addEventListener('htmx:afterSwap', (event) => {
            initTooltips();
            applyGlossaryTooltips(event.detail && event.detail.target ? event.detail.target : document);
        });

        document.body.addEventListener('keydown', (event) => {
            if (event.key === 'F1') {
                const active = document.activeElement;
                const trigger = active && active.closest('[data-help]');
                if (trigger) {
                    event.preventDefault();
                    lastHelpTrigger = trigger;
                    openHelp(trigger.getAttribute('data-help'));
                }
            }
        });
    });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
