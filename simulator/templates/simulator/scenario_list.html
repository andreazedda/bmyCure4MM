{% extends "base.html" %}

{% block content %}
<!-- Main Explanation Banner -->
<div class="alert alert-primary border-primary mb-4" role="alert">
    <div class="d-flex align-items-start gap-3">
        <div style="font-size: 3rem;">ğŸ¯</div>
        <div class="flex-grow-1">
            <h1 class="h4 alert-heading mb-2">
                <span class="t-en">Welcome to the Multiple Myeloma Treatment Simulator</span>
                <span class="t-it">Benvenuto al Simulatore Trattamenti Mieloma Multiplo</span>
            </h1>
            <div class="t-en">
                <p class="mb-2"><strong>What you see below:</strong> These are <strong>virtual patients</strong> (called "scenarios"). Each card represents 1 patient case with specific characteristics.</p>
                <p class="mb-2"><strong>What to do:</strong></p>
                <ol class="mb-2">
                    <li><strong>Choose a patient</strong> by clicking on any card below</li>
                    <li><strong>Read patient details</strong> (lab values, risk level)</li>
                    <li><strong>Test drug combinations</strong> on that patient</li>
                    <li><strong>See results</strong> (tumor reduction, side effects)</li>
                </ol>
                <p class="mb-0"><strong>ğŸ’¡ First time?</strong> Click the green button below to start with a beginner-friendly tutorial!</p>
            </div>
            <div class="t-it">
                <p class="mb-2"><strong>Cosa vedi sotto:</strong> Questi sono <strong>pazienti virtuali</strong> (chiamati "scenari"). Ogni card rappresenta 1 caso paziente con caratteristiche specifiche.</p>
                <p class="mb-2"><strong>Cosa fare:</strong></p>
                <ol class="mb-2">
                    <li><strong>Scegli un paziente</strong> cliccando su qualsiasi card sotto</li>
                    <li><strong>Leggi dettagli paziente</strong> (valori laboratorio, livello rischio)</li>
                    <li><strong>Testa combinazioni farmaci</strong> su quel paziente</li>
                    <li><strong>Vedi risultati</strong> (riduzione tumore, effetti collaterali)</li>
                </ol>
                <p class="mb-0"><strong>ğŸ’¡ Prima volta?</strong> Clicca il bottone verde sotto per iniziare con un tutorial per principianti!</p>
            </div>
        </div>
    </div>
</div>

{% if twin_assessment_id %}
<div class="alert alert-info border-info mb-4" role="alert">
    <div class="d-flex align-items-start gap-3">
        <div style="font-size: 2rem;">ğŸ§¬</div>
        <div class="flex-grow-1">
            <div class="fw-semibold mb-1">
                <span class="t-en">Patient Twin selected from Clinic</span>
                <span class="t-it">Gemello Paziente selezionato dalla Clinica</span>
            </div>
            <div class="small">
                <span class="t-en">Now pick any scenario below â†’ open it â†’ run the simulation. The â€œPatient Twin assessmentâ€ will be preselected.</span>
                <span class="t-it">Ora scegli uno scenario sotto â†’ aprilo â†’ avvia la simulazione. La â€œPatient Twin assessmentâ€ sarÃ  giÃ  preselezionata.</span>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="alert alert-secondary border-secondary mb-4" role="alert">
    <div class="d-flex align-items-start gap-3">
        <div style="font-size: 2rem;">ğŸ‘¤</div>
        <div class="flex-grow-1">
            <div class="fw-semibold mb-1">
                <span class="t-en">Looking for a real patient (e.g., Mario Rossi)?</span>
                <span class="t-it">Cerchi un paziente reale (es. Mario Rossi)?</span>
            </div>
            <div class="small mb-2">
                <span class="t-en">Real patients live in <strong>Clinic</strong>. The Simulator homepage shows only <strong>virtual training scenarios</strong>. To simulate Mario Rossi, open him in Clinic and click <strong>Open Simulator</strong>, then choose a scenario.</span>
                <span class="t-it">I pazienti reali sono nella <strong>Clinica</strong>. La home del Simulator mostra solo <strong>scenari virtuali</strong>. Per simulare Mario Rossi, aprilo in Clinica e clicca <strong>Apri Simulator</strong>, poi scegli uno scenario.</span>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-outline-dark" href="{% url 'clinic:patient_list' %}">
                    <span class="t-en">Go to Clinic â†’ Patients</span>
                    <span class="t-it">Vai a Clinica â†’ Pazienti</span>
                </a>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'simulator:visibility_diagnostics' %}">
                    <span class="t-en">Why donâ€™t I see my patient?</span>
                    <span class="t-it">PerchÃ© non vedo il mio paziente?</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Getting Started CTA -->
<div class="alert alert-success border-success mb-4" role="alert">
    <div class="d-flex align-items-center">
        <div class="flex-shrink-0 me-3">
            <span style="font-size: 2rem;">ğŸ“</span>
        </div>
        <div class="flex-grow-1">
            <h4 class="alert-heading mb-1">
                <span class="t-en">New to the Simulator?</span>
                <span class="t-it">Nuovo al Simulatore?</span>
            </h4>
            <p class="mb-2">
                <span class="t-en">Start with our step-by-step tutorial to learn how to simulate treatments, understand results, and practice with virtual patients.</span>
                <span class="t-it">Inizia con il nostro tutorial passo-passo per imparare a simulare trattamenti, comprendere risultati e praticare con pazienti virtuali.</span>
            </p>
            <a href="{% url 'simulator:getting_started' %}" class="btn btn-success">
                <span class="t-en">ğŸ“– Start Getting Started Guide (Recommended!)</span>
                <span class="t-it">ğŸ“– Inizia Guida Introduttiva (Consigliato!)</span>
            </a>
        </div>
    </div>
</div>

<!-- Risk Level Legend -->
<div class="card shadow-sm mb-4 border-info">
    <div class="card-header bg-info bg-opacity-10">
        <h5 class="mb-0">
            <span class="t-en">ğŸ·ï¸ Understanding Patient Labels (Risk Levels)</span>
            <span class="t-it">ğŸ·ï¸ Capire Etichette Pazienti (Livelli Rischio)</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <h6 class="text-success">ğŸŸ¢ Low Risk</h6>
                        <p class="small mb-1 t-en"><strong>Who:</strong> Newly diagnosed patients with favorable lab values</p>
                        <p class="small mb-1 t-it"><strong>Chi:</strong> Pazienti appena diagnosticati con valori favorevoli</p>
                        <p class="small mb-1 t-en"><strong>Treatment:</strong> Standard doses work well</p>
                        <p class="small mb-1 t-it"><strong>Trattamento:</strong> Dosi standard funzionano bene</p>
                        <p class="small mb-0 t-en"><strong>Best for beginners:</strong> âœ… Yes! Start here!</p>
                        <p class="small mb-0 t-it"><strong>Meglio per principianti:</strong> âœ… SÃ¬! Inizia qui!</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-warning">
                    <div class="card-body">
                        <h6 class="text-warning">ğŸŸ¡ Intermediate Risk</h6>
                        <p class="small mb-1 t-en"><strong>Who:</strong> Patients with moderate disease or complications</p>
                        <p class="small mb-1 t-it"><strong>Chi:</strong> Pazienti con malattia moderata o complicazioni</p>
                        <p class="small mb-1 t-en"><strong>Treatment:</strong> May need dose adjustments</p>
                        <p class="small mb-1 t-it"><strong>Trattamento:</strong> Potrebbero servire aggiustamenti dosi</p>
                        <p class="small mb-0 t-en"><strong>Best for beginners:</strong> âš ï¸ Try after Low Risk</p>
                        <p class="small mb-0 t-it"><strong>Meglio per principianti:</strong> âš ï¸ Prova dopo Basso Rischio</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-danger">
                    <div class="card-body">
                        <h6 class="text-danger">ğŸ”´ High Risk</h6>
                        <p class="small mb-1 t-en"><strong>Who:</strong> Advanced disease, poor lab values, or relapsed</p>
                        <p class="small mb-1 t-it"><strong>Chi:</strong> Malattia avanzata, valori scarsi, o recidiva</p>
                        <p class="small mb-1 t-en"><strong>Treatment:</strong> Requires careful dose balancing</p>
                        <p class="small mb-1 t-it"><strong>Trattamento:</strong> Richiede bilanciamento dosi attento</p>
                        <p class="small mb-0 t-en"><strong>Best for beginners:</strong> âŒ Advanced users only</p>
                        <p class="small mb-0 t-it"><strong>Meglio per principianti:</strong> âŒ Solo utenti avanzati</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="alert alert-info mt-3 mb-0">
            <p class="mb-0">
                <strong class="t-en">ğŸ’¡ Tip:</strong><strong class="t-it">ğŸ’¡ Consiglio:</strong>
                <span class="t-en">Look for the colored badges on each patient card below. Green = easiest, Yellow = medium, Red = hardest.</span>
                <span class="t-it">Cerca i badge colorati su ogni card paziente sotto. Verde = piÃ¹ facile, Giallo = medio, Rosso = piÃ¹ difficile.</span>
            </p>
        </div>
    </div>
</div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
    <h1 class="h3 mb-0">
        <span class="t-en">ğŸ‘¥ Available Virtual Patients</span>
        <span class="t-it">ğŸ‘¥ Pazienti Virtuali Disponibili</span>
    </h1>
    <span class="badge bg-primary fs-6">{{ scenarios|length }} <span class="t-en">patient{{ scenarios|length|pluralize }}</span><span class="t-it">pazient{{ scenarios|length|pluralize:"e,i" }}</span></span>
</div>

<div class="alert alert-light border mb-3">
    <div class="d-flex align-items-center gap-2">
        <span style="font-size: 1.5rem;">ğŸ‘‡</span>
        <div>
            <strong class="t-en">Choose a patient below to start:</strong>
            <strong class="t-it">Scegli un paziente sotto per iniziare:</strong>
            <span class="t-en">Click on any card to see patient details and simulate treatments</span>
            <span class="t-it">Clicca su qualsiasi card per vedere dettagli paziente e simulare trattamenti</span>
        </div>
    </div>
</div>

{% if scenarios %}
    <div class="row g-3">
        {% for scenario in scenarios %}
            <div class="col-md-6">
                <div class="card shadow-sm h-100 hover-card" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick="window.location='{% url 'simulator:scenario_detail' scenario.pk %}'">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h2 class="h5 mb-0"><a class="text-decoration-none stretched-link" href="{% url 'simulator:scenario_detail' scenario.pk %}">{{ scenario.title }}</a></h2>
                            {% if scenario.risk_stratification %}
                                {% if "Low" in scenario.risk_stratification or "Basso" in scenario.risk_stratification %}
                                    <span class="badge bg-success fs-6">ğŸŸ¢ {{ scenario.risk_stratification }}</span>
                                {% elif "High" in scenario.risk_stratification or "Alto" in scenario.risk_stratification %}
                                    <span class="badge bg-danger fs-6">ğŸ”´ {{ scenario.risk_stratification }}</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark fs-6">ğŸŸ¡ {{ scenario.risk_stratification }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        <p class="text-muted small mb-2">
                            <strong class="t-en">Stage:</strong><strong class="t-it">Stadio:</strong> {{ scenario.get_clinical_stage_display }}
                        </p>
                        <p class="mb-3">{{ scenario.summary|truncatewords:40 }}</p>
                        <div class="mt-auto">
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                {% with regs=scenario.recommended_regimens.all %}
                                    {% if regs %}
                                        <span class="badge bg-success">
                                            <span class="t-en">âœ… Guideline ready</span>
                                            <span class="t-it">âœ… Linee guida pronte</span>
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <span class="t-en">â³ Regimens pending</span>
                                            <span class="t-it">â³ Regimi in attesa</span>
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            {% with regs=scenario.recommended_regimens.all %}
                                {% if regs %}
                                    <div class="small text-muted">
                                        <strong class="t-en">Recommended:</strong><strong class="t-it">Raccomandato:</strong> {{ regs|join:", " }}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                    <div class="card-footer bg-light border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <span class="t-en">ğŸ‘† Click to open scenario details</span>
                                <span class="t-it">ğŸ‘† Clicca per aprire dettagli scenario</span>
                            </small>
                            <div class="d-flex gap-2">
                                <a class="badge bg-primary text-decoration-none" href="{% url 'simulator:scenario_detail' scenario.pk %}{% if twin_assessment_id %}?twin_assessment_id={{ twin_assessment_id|urlencode }}{% endif %}" onclick="event.stopPropagation();">
                                    <span class="t-en">View â†’</span>
                                    <span class="t-it">Vedi â†’</span>
                                </a>
                                {% if request.user.is_authenticated %}
                                    {% if twin_assessment_id %}
                                        <a class="badge bg-dark text-decoration-none" href="{% url 'simulator:scenario_detail' scenario.pk %}?twin_assessment_id={{ twin_assessment_id|urlencode }}&game=1#simulateScenarioPanel" onclick="event.stopPropagation();">
                                    {% else %}
                                        <a class="badge bg-dark text-decoration-none" href="{% url 'simulator:scenario_detail' scenario.pk %}?game=1#simulateScenarioPanel" onclick="event.stopPropagation();">
                                    {% endif %}
                                        <span class="t-en">ğŸ® Game</span>
                                        <span class="t-it">ğŸ® Gioco</span>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-secondary" role="alert">
        <span class="t-en">No scenarios configured yet. Use the admin to add training cases.</span>
        <span class="t-it">Nessuno scenario configurato. Usa l'admin per aggiungere casi di training.</span>
    </div>
{% endif %}

<style>
.hover-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2) !important;
}
</style>
{% endblock %}
