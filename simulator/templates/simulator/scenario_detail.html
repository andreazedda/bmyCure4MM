{% extends "base.html" %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'simulator:scenario_list' %}">Simulator</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ scenario.title }}</li>
    </ol>
</nav>

<div class="card shadow-sm mb-3">
    <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div>
                <div class="fw-semibold">
                    <span class="t-en">You are viewing</span>
                    <span class="t-it">Stai visualizzando</span>
                </div>
                <div class="text-muted small">
                    <span class="t-en">A training <strong>Scenario</strong> (virtual) plus an optional <strong>Patient Twin</strong> snapshot from Clinic.</span>
                    <span class="t-it">Uno <strong>Scenario</strong> di training (virtuale) pi√π un eventuale <strong>Patient Twin</strong> (snapshot) dalla Clinica.</span>
                </div>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-primary" href="#simulateScenarioPanel">
                    <span class="t-en">Open Simulation Panel</span>
                    <span class="t-it">Apri Pannello Simulazione</span>
                </a>
                <a class="btn btn-sm btn-outline-primary" href="#simulation-results">
                    <span class="t-en">See Results</span>
                    <span class="t-it">Vedi Risultati</span>
                </a>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'clinic:patient_list' %}">
                    <span class="t-en">Open Clinic</span>
                    <span class="t-it">Apri Clinica</span>
                </a>
            </div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
            <div class="col-md-6">
                <div class="border rounded p-2 h-100">
                    <div class="small text-muted">
                        <span class="t-en">Scenario (virtual patient)</span>
                        <span class="t-it">Scenario (paziente virtuale)</span>
                    </div>
                    <div class="fw-semibold">{{ scenario.title }}</div>
                    <div class="small text-muted">{{ scenario.get_clinical_stage_display }}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="border rounded p-2 h-100">
                    <div class="small text-muted">
                        <span class="t-en">Patient Twin (from Clinic)</span>
                        <span class="t-it">Patient Twin (dalla Clinica)</span>
                    </div>
                    {% if twin_error %}
                        <div class="text-danger small">{{ twin_error }}</div>
                        <div class="small text-muted">
                            <span class="t-en">Pick a patient in Clinic ‚Üí open Simulator again.</span>
                            <span class="t-it">Seleziona un paziente in Clinica ‚Üí riapri il Simulator.</span>
                        </div>
                    {% elif twin_label %}
                        <div class="fw-semibold">{{ twin_label }}</div>
                        <div class="small">
                            {% if twin_patient_pk %}
                                <a href="{% url 'clinic:patient_detail' twin_patient_pk %}" class="text-decoration-none">
                                    <span class="t-en">View patient in Clinic</span>
                                    <span class="t-it">Vedi paziente in Clinica</span>
                                </a>
                            {% endif %}
                            <span class="text-muted">¬∑</span>
                            <a href="{% url 'simulator:scenario_list' %}?twin_assessment_id={{ twin_assessment_id|urlencode }}" class="text-decoration-none">
                                <span class="t-en">Change scenario</span>
                                <span class="t-it">Cambia scenario</span>
                            </a>
                        </div>
                        <div class="small text-muted">
                            <span class="t-en">This uses the selected patient‚Äôs labs/assessment as biology inputs (the scenario is still virtual).</span>
                            <span class="t-it">Questo usa i laboratori/assessment del paziente selezionato come input biologici (lo scenario resta virtuale).</span>
                        </div>
                    {% else %}
                        <div class="fw-semibold">
                            <span class="t-en">None selected</span>
                            <span class="t-it">Nessuno selezionato</span>
                        </div>
                        <div class="small text-muted">
                            <span class="t-en">To simulate Mario Rossi: open him in Clinic ‚Üí click Open Simulator.</span>
                            <span class="t-it">Per simulare Mario Rossi: aprilo in Clinica ‚Üí clicca Apri Simulator.</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- START: Complete Explanation Section -->
<div class="alert alert-info mb-4">
    <div class="d-flex align-items-start gap-3">
        <div style="font-size: 2rem;">üí°</div>
        <div class="flex-grow-1">
            <h4 class="alert-heading">
                <span class="t-en">How to Simulate a Therapy - Complete Guide</span>
                <span class="t-it">Come Simulare una Terapia - Guida Completa</span>
            </h4>
            <hr>
            <div class="t-en">
                <p class="mb-2"><strong>What is this page?</strong></p>
                <p>This is a <strong>virtual patient</strong> called "<em>{{ scenario.title }}</em>". You'll test drug combinations on this patient to see what happens - but it's completely safe because it's simulated!</p>
                
                <p class="mb-2 mt-3"><strong>How do I simulate a therapy? (4 Simple Steps)</strong></p>
                <ol class="mb-0">
                    <li><strong>Check the patient's lab values</strong> below (in "Key Laboratory Snapshot") - if values are out of safe range, the system blocks the simulation for safety</li>
                    <li><strong>Click "Open Simulation Panel"</strong> (blue button at top right)</li>
                    <li><strong>Choose your drugs and doses</strong> in the form that appears - see drug details below!</li>
                    <li><strong>Click "Run simulation"</strong> at the bottom of the form - results appear in 5-30 seconds</li>
                </ol>

                <div class="alert alert-success mt-3 mb-0">
                    <strong>üéØ Quick Tip:</strong> First time? Use the preset "Standard" doses - they're safe starting values!
                </div>
            </div>
            <div class="t-it">
                <p class="mb-2"><strong>Cos'√® questa pagina?</strong></p>
                <p>Questo √® un <strong>paziente virtuale</strong> chiamato "<em>{{ scenario.title }}</em>". Testerai combinazioni di farmaci su questo paziente per vedere cosa succede - ma √® completamente sicuro perch√© √® simulato!</p>
                
                <p class="mb-2 mt-3"><strong>Come simulo una terapia? (4 Passi Semplici)</strong></p>
                <ol class="mb-0">
                    <li><strong>Controlla i valori di laboratorio</strong> del paziente qui sotto (in "Key Laboratory Snapshot") - se i valori sono fuori dal range sicuro, il sistema blocca la simulazione per sicurezza</li>
                    <li><strong>Clicca "Apri Pannello Simulazione"</strong> (bottone blu in alto a destra)</li>
                    <li><strong>Scegli farmaci e dosi</strong> nel form che appare - vedi dettagli farmaci sotto!</li>
                    <li><strong>Clicca "Esegui simulazione"</strong> in fondo al form - risultati appaiono in 5-30 secondi</li>
                </ol>

                <div class="alert alert-success mt-3 mb-0">
                    <strong>üéØ Consiglio Rapido:</strong> Prima volta? Usa il preset "Standard" - sono dosi sicure di partenza!
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drug Information Cards -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="h5 mb-0">
            <span class="t-en">üíä Available Drugs - What They Do & How to Dose</span>
            <span class="t-it">üíä Farmaci Disponibili - Cosa Fanno e Come Dosarli</span>
        </h3>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <!-- Lenalidomide -->
            <div class="col-md-4">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary bg-opacity-10">
                        <h4 class="h6 mb-0">
                            <span class="t-en">Lenalidomide (Revlimid)</span>
                            <span class="t-it">Lenalidomide (Revlimid)</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong class="t-en">Trade Name:</strong><strong class="t-it">Nome Commerciale:</strong> <span class="badge bg-info">Revlimid</span></p>
                        
                        <p class="mb-2"><strong class="t-en">What it does:</strong><strong class="t-it">Cosa fa:</strong></p>
                        <ul class="small mb-2">
                            <li class="t-en">Wakes up your immune system to attack myeloma cells</li>
                            <li class="t-en">Stops new blood vessels from feeding the tumor</li>
                            <li class="t-it">Sveglia il sistema immunitario per attaccare le cellule del mieloma</li>
                            <li class="t-it">Blocca nuovi vasi sanguigni che nutrono il tumore</li>
                        </ul>

                        <p class="mb-2"><strong class="t-en">How to use:</strong><strong class="t-it">Come si usa:</strong></p>
                        <ul class="small mb-2">
                            <li class="t-en">üíä Oral pill (capsule)</li>
                            <li class="t-en">üìÖ Daily for 21 days, then 7 days off (28-day cycle)</li>
                            <li class="t-it">üíä Pastiglia orale (capsula)</li>
                            <li class="t-it">üìÖ Ogni giorno per 21 giorni, poi 7 giorni di pausa (ciclo 28 giorni)</li>
                        </ul>

                        <p class="mb-2"><strong class="t-en">Typical Doses:</strong><strong class="t-it">Dosi Tipiche:</strong></p>
                        <table class="table table-sm table-bordered mb-2">
                            <tr>
                                <td class="t-en">Normal kidneys</td>
                                <td class="t-it">Reni normali</td>
                                <td><strong>25 mg/day</strong></td>
                            </tr>
                            <tr>
                                <td class="t-en">Mild kidney problems</td>
                                <td class="t-it">Problemi renali lievi</td>
                                <td><strong>15 mg/day</strong></td>
                            </tr>
                            <tr>
                                <td class="t-en">Severe kidney problems</td>
                                <td class="t-it">Problemi renali gravi</td>
                                <td><strong>10 mg/day</strong></td>
                            </tr>
                        </table>

                        <div class="alert alert-warning alert-sm mb-0">
                            <small><strong class="t-en">‚ö†Ô∏è Important:</strong><strong class="t-it">‚ö†Ô∏è Importante:</strong> <span class="t-en">Reduce dose if kidneys don't work well (check Creatinine Clearance)</span><span class="t-it">Riduci la dose se i reni non funzionano bene (controlla Creatinina Clearance)</span></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bortezomib -->
            <div class="col-md-4">
                <div class="card h-100 border-success">
                    <div class="card-header bg-success bg-opacity-10">
                        <h4 class="h6 mb-0">
                            <span class="t-en">Bortezomib (Velcade)</span>
                            <span class="t-it">Bortezomib (Velcade)</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong class="t-en">Trade Name:</strong><strong class="t-it">Nome Commerciale:</strong> <span class="badge bg-success">Velcade</span></p>
                        
                        <p class="mb-2"><strong class="t-en">What it does:</strong><strong class="t-it">Cosa fa:</strong></p>
                        <ul class="small mb-2">
                            <li class="t-en">Blocks the "waste disposal" system of myeloma cells</li>
                            <li class="t-en">Cells fill with toxic waste and die</li>
                            <li class="t-it">Blocca il sistema di "smaltimento rifiuti" delle cellule del mieloma</li>
                            <li class="t-it">Le cellule si riempiono di rifiuti tossici e muoiono</li>
                        </ul>

                        <p class="mb-2"><strong class="t-en">How to use:</strong><strong class="t-it">Come si usa:</strong></p>
                        <ul class="small mb-2">
                            <li class="t-en">üíâ Injection (under skin or IV)</li>
                            <li class="t-en">üìÖ Twice per week (Day 1, 4, 8, 11 of 21-day cycle)</li>
                            <li class="t-it">üíâ Iniezione (sottocute o endovena)</li>
                            <li class="t-it">üìÖ Due volte a settimana (Giorno 1, 4, 8, 11 di ciclo 21 giorni)</li>
                        </ul>

                        <p class="mb-2"><strong class="t-en">Typical Doses:</strong><strong class="t-it">Dosi Tipiche:</strong></p>
                        <table class="table table-sm table-bordered mb-2">
                            <tr>
                                <td class="t-en">Standard dose</td>
                                <td class="t-it">Dose standard</td>
                                <td><strong>1.3 mg/m¬≤</strong></td>
                            </tr>
                            <tr>
                                <td class="t-en">If neuropathy (tingling)</td>
                                <td class="t-it">Se neuropatia (formicolio)</td>
                                <td><strong>1.0 mg/m¬≤</strong></td>
                            </tr>
                            <tr>
                                <td class="t-en">Elderly/frail patient</td>
                                <td class="t-it">Paziente anziano/fragile</td>
                                <td><strong>1.0 mg/m¬≤</strong></td>
                            </tr>
                        </table>

                        <div class="alert alert-warning alert-sm mb-0">
                            <small><strong class="t-en">‚ö†Ô∏è Watch for:</strong><strong class="t-it">‚ö†Ô∏è Attenzione a:</strong> <span class="t-en">Tingling/numbness in hands/feet (neuropathy) - reduce dose if it happens</span><span class="t-it">Formicolio/intorpidimento mani/piedi (neuropatia) - riduci dose se capita</span></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daratumumab -->
            <div class="col-md-4">
                <div class="card h-100 border-danger">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h4 class="h6 mb-0">
                            <span class="t-en">Daratumumab (Darzalex)</span>
                            <span class="t-it">Daratumumab (Darzalex)</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong class="t-en">Trade Name:</strong><strong class="t-it">Nome Commerciale:</strong> <span class="badge bg-danger">Darzalex</span></p>
                        
                        <p class="mb-2"><strong class="t-en">What it does:</strong><strong class="t-it">Cosa fa:</strong></p>
                        <ul class="small mb-2">
                            <li class="t-en">Antibody that sticks to myeloma cells</li>
                            <li class="t-en">Marks them so immune system destroys them</li>
                            <li class="t-it">Anticorpo che si attacca alle cellule del mieloma</li>
                            <li class="t-it">Le marca cos√¨ il sistema immunitario le distrugge</li>
                        </ul>

                        <p class="mb-2"><strong class="t-en">How to use:</strong><strong class="t-it">Come si usa:</strong></p>
                        <ul class="small mb-2">
                            <li class="t-en">üíâ IV infusion (slow drip, 3-7 hours first time)</li>
                            <li class="t-en">üìÖ Weekly for 8 weeks, then every 2 weeks, then monthly</li>
                            <li class="t-it">üíâ Infusione endovenosa (goccia lenta, 3-7 ore prima volta)</li>
                            <li class="t-it">üìÖ Settimanale per 8 settimane, poi ogni 2 settimane, poi mensile</li>
                        </ul>

                        <p class="mb-2"><strong class="t-en">Typical Doses:</strong><strong class="t-it">Dosi Tipiche:</strong></p>
                        <table class="table table-sm table-bordered mb-2">
                            <tr>
                                <td class="t-en">Standard dose</td>
                                <td class="t-it">Dose standard</td>
                                <td><strong>16 mg/kg</strong></td>
                            </tr>
                            <tr>
                                <td class="t-en">Example: 70 kg patient</td>
                                <td class="t-it">Esempio: paziente 70 kg</td>
                                <td><strong>1120 mg total</strong></td>
                            </tr>
                        </table>

                        <div class="alert alert-info alert-sm mb-0">
                            <small><strong class="t-en">‚ÑπÔ∏è Note:</strong><strong class="t-it">‚ÑπÔ∏è Nota:</strong> <span class="t-en">Dose doesn't change based on kidney/liver function - it's based on body weight only</span><span class="t-it">La dose non cambia in base a funzione reni/fegato - si basa solo sul peso corporeo</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-primary mt-3 mb-0">
            <h5 class="alert-heading">
                <span class="t-en">ü§ù How to Combine These Drugs (Drug Combos)</span>
                <span class="t-it">ü§ù Come Combinare Questi Farmaci (Combinazioni)</span>
            </h5>
            <p class="t-en mb-2">When you click "Open Simulation Panel", you'll see a form with 3 sections for the 3 drugs. You can:</p>
            <p class="t-it mb-2">Quando clicchi "Apri Pannello Simulazione", vedrai un form con 3 sezioni per i 3 farmaci. Puoi:</p>
            <ul class="mb-2">
                <li class="t-en"><strong>Use all 3 together</strong> (Triplet therapy - Len + Bort + Dara) = Most powerful!</li>
                <li class="t-en"><strong>Use 2 drugs</strong> (Doublet therapy - Len + Dara OR Len + Bort) = Good balance</li>
                <li class="t-en"><strong>Use 1 drug</strong> (Monotherapy - Just Lenalidomide) = For maintenance or frail patients</li>
                <li class="t-it"><strong>Usa tutti e 3 insieme</strong> (Tripletta - Len + Bort + Dara) = Pi√π potente!</li>
                <li class="t-it"><strong>Usa 2 farmaci</strong> (Doppietta - Len + Dara O Len + Bort) = Buon equilibrio</li>
                <li class="t-it"><strong>Usa 1 farmaco</strong> (Monoterapia - Solo Lenalidomide) = Per mantenimento o pazienti fragili</li>
            </ul>
            <p class="mb-0">
                <strong class="t-en">üí° Tip:</strong><strong class="t-it">üí° Consiglio:</strong> 
                <span class="t-en">Set a drug dose to <code>0</code> if you don't want to use it. For example: Lenalidomide = 25, Bortezomib = 1.3, Daratumumab = 0 means you're using only Len + Bort.</span>
                <span class="t-it">Imposta la dose di un farmaco a <code>0</code> se non vuoi usarlo. Per esempio: Lenalidomide = 25, Bortezomib = 1.3, Daratumumab = 0 significa che usi solo Len + Bort.</span>
            </p>
        </div>
    </div>
</div>

<!-- Virtual Patient Cohort Explanation -->
<div class="card shadow-sm mb-4 border-warning">
    <div class="card-header bg-warning bg-opacity-10">
        <h3 class="h5 mb-0">
            <span class="t-en">üë• What are "Virtual Patients"? (Cohort Explained)</span>
            <span class="t-it">üë• Cosa sono i "Pazienti Virtuali"? (Coorte Spiegata)</span>
        </h3>
    </div>
    <div class="card-body">
        <div class="t-en">
            <p class="mb-2"><strong>What you see on this page:</strong> 1 patient profile ("<em>{{ scenario.title }}</em>") with specific lab values</p>
            
            <p class="mb-2"><strong>What the simulator actually tests:</strong> Not just 1 patient, but a whole GROUP (called "cohort") of similar patients!</p>
            
            <p class="mb-3"><strong>Why?</strong> Because in real life, even 2 patients with identical lab values respond differently. So we simulate 30-100 virtual patients with slight variations to get realistic average results.</p>
            
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6>üìä Mathematical Characteristics of Each Virtual Patient:</h6>
                    <p class="mb-2">Each virtual patient in the cohort has these parameters (slightly randomized):</p>
                    <ul class="small mb-0">
                        <li><strong>Initial Tumor Cells:</strong> Based on disease stage (Low Risk: ~1M cells, High Risk: ~5M cells)</li>
                        <li><strong>Initial Healthy Cells:</strong> Based on lab values (ANC, Platelets)</li>
                        <li><strong>Tumor Growth Rate:</strong> How fast myeloma cells multiply (0.05-0.15/day)</li>
                        <li><strong>Healthy Cell Growth Rate:</strong> How fast healthy cells recover (0.1-0.2/day)</li>
                        <li><strong>Drug Sensitivity:</strong> How well each drug works on this patient (EC50 values)</li>
                        <li><strong>Drug Clearance:</strong> How fast kidneys/liver eliminate drugs (based on Creatinine Clearance)</li>
                        <li><strong>Interaction Strength:</strong> How much tumor cells compete with healthy cells</li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-success mb-0">
                <strong>üéØ When you run a simulation:</strong>
                <ol class="mb-0">
                    <li>System creates 30-100 virtual patients (you choose "Cohort Size" in the form)</li>
                    <li>Each has slightly different parameters (randomized within realistic ranges)</li>
                    <li>System simulates treatment on ALL of them</li>
                    <li>Results show the AVERAGE outcome + variation range</li>
                </ol>
                <p class="mb-0 mt-2"><strong>Example:</strong> If you test on 100 virtual patients and get "Tumor Reduction: 75%", it means on average across all 100 patients, the tumor shrank by 75%. Some patients had 80% reduction, some had 70%, but average is 75%.</p>
            </div>
        </div>
        <div class="t-it">
            <p class="mb-2"><strong>Cosa vedi in questa pagina:</strong> 1 profilo paziente ("<em>{{ scenario.title }}</em>") con valori di laboratorio specifici</p>
            
            <p class="mb-2"><strong>Cosa testa realmente il simulatore:</strong> Non solo 1 paziente, ma un intero GRUPPO (chiamato "coorte") di pazienti simili!</p>
            
            <p class="mb-3"><strong>Perch√©?</strong> Perch√© nella vita reale, anche 2 pazienti con valori di laboratorio identici rispondono diversamente. Quindi simuliamo 30-100 pazienti virtuali con leggere variazioni per ottenere risultati medi realistici.</p>
            
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6>üìä Caratteristiche Matematiche di Ogni Paziente Virtuale:</h6>
                    <p class="mb-2">Ogni paziente virtuale nella coorte ha questi parametri (leggermente randomizzati):</p>
                    <ul class="small mb-0">
                        <li><strong>Cellule Tumorali Iniziali:</strong> Basato su stadio malattia (Basso Rischio: ~1M cellule, Alto Rischio: ~5M cellule)</li>
                        <li><strong>Cellule Sane Iniziali:</strong> Basato su valori di laboratorio (ANC, Piastrine)</li>
                        <li><strong>Velocit√† Crescita Tumore:</strong> Quanto velocemente si moltiplicano le cellule mieloma (0.05-0.15/giorno)</li>
                        <li><strong>Velocit√† Crescita Cellule Sane:</strong> Quanto velocemente si riprendono le cellule sane (0.1-0.2/giorno)</li>
                        <li><strong>Sensibilit√† ai Farmaci:</strong> Quanto bene funziona ogni farmaco su questo paziente (valori EC50)</li>
                        <li><strong>Eliminazione Farmaci:</strong> Quanto velocemente reni/fegato eliminano i farmaci (basato su Creatinina Clearance)</li>
                        <li><strong>Forza Interazione:</strong> Quanto le cellule tumorali competono con quelle sane</li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-success mb-0">
                <strong>üéØ Quando esegui una simulazione:</strong>
                <ol class="mb-0">
                    <li>Il sistema crea 30-100 pazienti virtuali (tu scegli "Cohort Size" nel form)</li>
                    <li>Ognuno ha parametri leggermente diversi (randomizzati entro range realistici)</li>
                    <li>Il sistema simula il trattamento su TUTTI loro</li>
                    <li>I risultati mostrano l'esito MEDIO + range di variazione</li>
                </ol>
                <p class="mb-0 mt-2"><strong>Esempio:</strong> Se testi su 100 pazienti virtuali e ottieni "Riduzione Tumore: 75%", significa che in media su tutti i 100 pazienti, il tumore si √® ridotto del 75%. Alcuni pazienti avevano riduzione 80%, altri 70%, ma la media √® 75%.</p>
            </div>
        </div>
    </div>
</div>
<!-- END: Complete Explanation Section -->

<div class="row g-3 mb-3">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-start gap-2">
                    <div>
                        <h1 class="h4 mb-1">{{ scenario.title }}</h1>
                        <p class="text-muted mb-2">{{ scenario.get_clinical_stage_display }}</p>
                    </div>
                    {% if request.user.is_authenticated %}
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-primary btn-sm"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#simulateScenarioPanel"
                                    aria-controls="simulateScenarioPanel"
                                    aria-expanded="{% if game_mode or prefill_twin %}true{% else %}false{% endif %}">
                                <span class="t-en">Open Simulation Panel</span>
                                <span class="t-it">Apri Pannello Simulazione</span>
                            </button>
                            {% if is_editor %}
                            <a href="{% url 'simulator:scenario_edit' scenario.pk %}" class="btn btn-outline-secondary btn-sm">Edit</a>
                            <form method="post" action="{% url 'simulator:scenario_duplicate' scenario.pk %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-dark btn-sm">Duplicate</button>
                            </form>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="offcanvas" data-bs-target="#manageRegimensOffcanvas" aria-controls="manageRegimensOffcanvas" aria-expanded="false">
                                Manage Regimens
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% if scenario.risk_stratification %}
                    <span class="badge bg-warning text-dark mb-3">{{ scenario.risk_stratification }}</span>
                {% endif %}

                <div class="alert alert-info small">
                    <div class="t-en">
                        <strong>What is this section?</strong> This is the scenario overview (virtual patient). If a <strong>Patient Twin</strong> is selected, its Assessment provides lab-driven biology inputs.
                    </div>
                    <div class="t-it">
                        <strong>Cos'√® questa sezione?</strong> Questo √® l‚Äôoverview dello scenario (paziente virtuale). Se selezioni un <strong>Patient Twin</strong>, il suo Assessment fornisce input biologici guidati dai laboratori.
                    </div>
                    <div class="mt-2">
                        {% if twin_label %}
                            <div>
                                <span class="t-en"><strong>Patient Twin selected:</strong> {{ twin_label }}</span>
                                <span class="t-it"><strong>Patient Twin selezionato:</strong> {{ twin_label }}</span>
                                {% if twin_patient_pk %}
                                    <span class="text-muted">¬∑</span>
                                    <a href="{% url 'clinic:patient_detail' twin_patient_pk %}" class="text-decoration-none">
                                        <span class="t-en">Open in Clinic</span>
                                        <span class="t-it">Apri in Clinica</span>
                                    </a>
                                {% endif %}
                            </div>
                        {% elif twin_error %}
                            <div class="text-danger">{{ twin_error }}</div>
                        {% else %}
                            <div class="text-muted">
                                <span class="t-en"><strong>No Patient Twin selected.</strong> To simulate Mario Rossi: open him in Clinic ‚Üí Open Simulator.</span>
                                <span class="t-it"><strong>Nessun Patient Twin selezionato.</strong> Per simulare Mario Rossi: aprilo in Clinica ‚Üí Apri Simulator.</span>
                            </div>
                        {% endif %}
                    </div>
                    <hr class="my-2">
                    <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-sm btn-primary" href="#simulateScenarioPanel">
                            <span class="t-en">Open Simulation Panel</span>
                            <span class="t-it">Apri Pannello Simulazione</span>
                        </a>
                        <a class="btn btn-sm btn-outline-primary" href="#simulation-results">
                            <span class="t-en">See Results</span>
                            <span class="t-it">Vedi Risultati</span>
                        </a>
                        <a class="btn btn-sm btn-outline-secondary" href="{% url 'simulator:scenario_list' %}{% if twin_assessment_id %}?twin_assessment_id={{ twin_assessment_id|urlencode }}{% endif %}">
                            <span class="t-en">Change Scenario</span>
                            <span class="t-it">Cambia Scenario</span>
                        </a>
                    </div>
                    <div class="mt-2 text-muted">
                        <span class="t-en">Results always appear on this page under <strong>Simulation Results</strong> (right column).</span>
                        <span class="t-it">I risultati appaiono sempre in questa pagina sotto <strong>Simulation Results</strong> (colonna destra).</span>
                    </div>
                </div>
                <p>{{ scenario.summary }}</p>
                {% if scenario.lab_items %}
                    <hr>
                    <h2 class="h5">Key Laboratory Snapshot</h2>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <tbody>
                                {% for label, value in scenario.lab_items %}
                                    <tr>
                                        <th class="w-50">{{ label }}</th>
                                        <td>{{ value }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% if recommended_regimens %}
                    <hr>
                    <h2 class="h5">Guideline Reference</h2>
                    <p class="mb-1"><strong>Aligned regimen(s):</strong> {{ regimen_names }}</p>
                    {% if scenario.expected_response %}
                        <p class="mb-0"><strong>Target response:</strong> {{ scenario.get_expected_response_display }}</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h2 class="h6 mb-2">
                    <span class="t-en">What do I do now?</span>
                    <span class="t-it">Cosa devo fare adesso?</span>
                </h2>
                <ol class="small mb-3">
                    <li>
                        <span class="t-en">Confirm Patient Twin (optional)</span>
                        <span class="t-it">Conferma Patient Twin (opzionale)</span>
                        {% if twin_label %}
                            <div class="text-muted">{{ twin_label }}</div>
                        {% else %}
                            <div class="text-muted">
                                <span class="t-en">Not selected ‚Üí to use Mario Rossi, open him in Clinic ‚Üí Open Simulator.</span>
                                <span class="t-it">Non selezionato ‚Üí per usare Mario Rossi, aprilo in Clinica ‚Üí Apri Simulator.</span>
                            </div>
                        {% endif %}
                    </li>
                    <li>
                        <span class="t-en">Open the Simulation Panel</span>
                        <span class="t-it">Apri il Pannello Simulazione</span>
                        <div class="text-muted">
                            <span class="t-en">Use the blue button on the left.</span>
                            <span class="t-it">Usa il bottone blu a sinistra.</span>
                        </div>
                    </li>
                    <li>
                        <span class="t-en">Run a first safe test</span>
                        <span class="t-it">Esegui un primo test sicuro</span>
                        <div class="text-muted">
                            <span class="t-en">Inside the panel, click ‚ÄúBeginner: run in 1 click‚Äù, or keep the preset and click ‚ÄúRun simulation‚Äù.</span>
                            <span class="t-it">Nel pannello, clicca ‚ÄúBeginner: run in 1 click‚Äù, oppure lascia il preset e clicca ‚ÄúEsegui simulazione‚Äù.</span>
                        </div>
                    </li>
                    <li>
                        <span class="t-en">Read outcomes</span>
                        <span class="t-it">Leggi gli esiti</span>
                        <div class="text-muted">
                            <span class="t-en">Results appear below in ‚ÄúSimulation Results‚Äù. Check the badges/warnings (Good/Monitor/Toxic).</span>
                            <span class="t-it">I risultati appaiono sotto in ‚ÄúSimulation Results‚Äù. Controlla badge/avvisi (Good/Monitor/Toxic).</span>
                        </div>
                    </li>
                </ol>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-sm btn-primary" href="#simulateScenarioPanel">
                        <span class="t-en">Open Simulation Panel</span>
                        <span class="t-it">Apri Pannello</span>
                    </a>
                    <a class="btn btn-sm btn-outline-primary" href="#simulation-results">
                        <span class="t-en">Jump to Results</span>
                        <span class="t-it">Vai ai Risultati</span>
                    </a>
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'clinic:patient_list' %}">
                        <span class="t-en">Find patient in Clinic</span>
                        <span class="t-it">Cerca paziente in Clinica</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="h5">Submit Your Plan</h2>
                <div class="alert alert-secondary small" role="alert">
                    <span class="t-en"><strong>What this does:</strong> Records your chosen regimen/notes for this scenario (training + guideline comparison). It does <strong>not</strong> run the mathematical model.</span>
                    <span class="t-it"><strong>Cosa fa:</strong> Registra regime/note scelti per questo scenario (training + confronto con linee guida). <strong>Non</strong> esegue il modello matematico.</span>
                    <div class="mt-1">
                        <span class="t-en"><strong>To get model results:</strong> open the Simulation Panel (blue button on the left), then click <strong>Run simulation</strong> inside the form. Results appear in <strong>Simulation Results</strong> below.</span>
                        <span class="t-it"><strong>Per avere risultati del modello:</strong> apri il Pannello Simulazione (bottone blu a sinistra), poi clicca <strong>Esegui simulazione</strong> nel form. I risultati appaiono in <strong>Risultati della simulazione</strong> sotto.</span>
                    </div>
                </div>
                <form method="post" class="pt-2">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">{{ form.non_field_errors }}</div>
                    {% endif %}
                    {% for field in form %}
                        <div class="mb-3">
                            <label class="form-label" for="id_{{ field.name }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                            {% if field.errors %}
                                <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary w-100">Record Decision</button>
                </form>
            </div>
        </div>
        {% if request.user.is_authenticated %}
            <!-- Fix overlapping cards and ensure single simulation results container -->
            <div id="simulation-status" class="alert alert-light small py-2 mb-2" role="status" aria-live="polite">
                {% if latest_simulation %}
                    <span class="t-en"><strong>Status:</strong> Showing the latest run below. You can run again anytime.</span>
                    <span class="t-it"><strong>Stato:</strong> Qui sotto vedi l‚Äôultima esecuzione. Puoi rieseguire in qualsiasi momento.</span>
                {% else %}
                    <span class="t-en"><strong>Status:</strong> No results yet. Open the Simulation Panel ‚Üí click <strong>Run simulation</strong>.</span>
                    <span class="t-it"><strong>Stato:</strong> Nessun risultato ancora. Apri il Pannello Simulazione ‚Üí clicca <strong>Esegui simulazione</strong>.</span>
                {% endif %}
            </div>
            <div id="simulation-results" class="mt-3">
                {% include "simulator/_simulation_results.html" with scenario=scenario attempt=latest_simulation summary=latest_simulation_summary results=latest_simulation_results kpi=kpi game_mode=game_mode game=game %}
            </div>
            {% if not latest_simulation %}
                {% include "simulator/_simulation_wizard.html" %}
            {% endif %}
        {% endif %}
        {% if is_editor %}
            <div id="pareto-panel" class="mt-3"></div>
        {% endif %}

        {% if is_editor %}
            <div class="card shadow-sm mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h6 mb-0">Guideline Regimens</h2>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#manageRegimensOffcanvas" aria-controls="manageRegimensOffcanvas" aria-expanded="false">
                        Manage
                    </button>
                </div>
                <div class="card-body">
                    <div id="guideline-regimens-card-body">
                        {% include "simulator/_guideline_regimens_card.html" with scenario=scenario regimens=recommended_regimens available_regimens=available_regimens target_id="guideline-regimens-card-body" allow_multiple=False %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% if guide_articles %}
<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Guide</h2>
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="Tour.open()" data-audit="tour_start">
            <span class="t-en">Start Tutorial</span><span class="t-it">Avvia Tutorial</span>
        </button>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs mb-3" id="guideTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="guide-en-tab" data-bs-toggle="tab" data-bs-target="#guide-en" type="button" role="tab" aria-controls="guide-en" aria-selected="true">EN</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="guide-it-tab" data-bs-toggle="tab" data-bs-target="#guide-it" type="button" role="tab" aria-controls="guide-it" aria-selected="false">IT</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="guide-index-tab" data-bs-toggle="tab" data-bs-target="#guide-index" type="button" role="tab" aria-controls="guide-index" aria-selected="false">
                    <span class="t-en">Field Reference</span>
                    <span class="t-it">Riferimenti</span>
                </button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="guide-en" role="tabpanel">
                {% for slug, data in guide_articles.items %}
                    <h3 class="h6">{{ data.en.title }}</h3>
                    <div class="small text-body mb-3">{{ data.en.body|safe }}</div>
                {% endfor %}
            </div>
            <div class="tab-pane fade" id="guide-it" role="tabpanel">
                {% for slug, data in guide_articles.items %}
                    <h3 class="h6">{{ data.it.title }}</h3>
                    <div class="small text-body mb-3">{{ data.it.body|safe }}</div>
                {% endfor %}
            </div>
            <div class="tab-pane fade" id="guide-index" role="tabpanel">
                <div class="list-group">
                    {% for item in help_index %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">{{ item.title_en }}</div>
                                <div class="text-muted small">{{ item.title_it }}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" data-help="{{ item.slug }}">
                                <span class="t-en">Open</span><span class="t-it">Apri</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">
            <span class="t-en">Simulation Runs</span>
            <span class="t-it">Esecuzioni Simulazione</span>
        </h2>
        <span class="badge bg-secondary">{{ simulation_runs_count }}</span>
    </div>
    <div class="card-body p-0">
        <div class="px-3 pt-3">
            <div class="alert alert-info py-2 mb-0">
                <div class="small">
                    <span class="t-en"><strong>What happens when you click Run simulation?</strong> The mathematical model runs and the output appears on this page under <strong>Simulation Results</strong> (right column).</span>
                    <span class="t-it"><strong>Cosa succede quando clicchi Esegui simulazione?</strong> Esegue il modello matematico e l‚Äôoutput appare in questa pagina sotto <strong>Risultati della simulazione</strong> (colonna destra).</span>
                </div>
            </div>
        </div>
        {% if simulation_runs %}
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>When</th>
                            <th>User</th>
                            <th>Preset</th>
                            <th>Twin</th>
                            <th>Tumor</th>
                            <th>Healthy</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for run in simulation_runs %}
                            <tr>
                                <td>{{ run.submitted|date:"Y-m-d H:i" }}</td>
                                <td>{{ run.user.username|default:"anonymous" }}</td>
                                <td>{{ run.parameters.preset|default:"‚Äî" }}</td>
                                <td>
                                    {% if run.parameters.use_twin %}
                                        <span class="badge bg-success">On</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Off</span>
                                    {% endif %}
                                </td>
                                <td>{{ run.results_summary.tumor_reduction|default_if_none:"‚Äî"|floatformat:2 }}</td>
                                <td>{{ run.results_summary.healthy_loss|default_if_none:"‚Äî"|floatformat:2 }}</td>
                                <td>
                                    {% if run.results_summary.healthy_loss and run.results_summary.healthy_loss > 0.3 %}
                                        <span class="badge bg-danger">Toxic</span>
                                    {% elif run.results_summary.tumor_reduction and run.results_summary.tumor_reduction >= 0.9 and run.results_summary.healthy_loss and run.results_summary.healthy_loss <= 0.25 %}
                                        <span class="badge bg-success">Good</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Monitor</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if simulation_runs_count > 20 %}
                <div class="px-3 py-2 text-muted small">
                    <span class="t-en">Showing latest 20 of {{ simulation_runs_count }}.</span>
                    <span class="t-it">Mostro le ultime 20 di {{ simulation_runs_count }}.</span>
                </div>
            {% endif %}
        {% else %}
            <p class="m-3 text-muted">
                <span class="t-en">No simulation runs yet. Open the <strong>Simulation Panel</strong>, then click <strong>Run simulation</strong> to generate results.</span>
                <span class="t-it">Nessuna simulazione eseguita. Apri il <strong>Pannello Simulazione</strong>, poi clicca <strong>Esegui simulazione</strong> per generare risultati.</span>
            </p>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">
            <span class="t-en">Decision Log</span>
            <span class="t-it">Registro Decisioni</span>
        </h2>
        <span class="badge bg-secondary">{{ decision_logs_count }}</span>
    </div>
    <div class="card-body p-0">
        <div class="px-3 pt-3">
            <div class="alert alert-secondary py-2 mb-0">
                <div class="small">
                    <span class="t-en"><strong>What happens when you click Record Decision?</strong> It saves your plan (for training/guideline comparison). It does <strong>not</strong> run the model.</span>
                    <span class="t-it"><strong>Cosa succede quando clicchi Record Decision?</strong> Salva il tuo piano (training/confronto linee guida). <strong>Non</strong> esegue il modello.</span>
                </div>
            </div>
        </div>
        {% if decision_logs %}
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>When</th>
                            <th>Clinician</th>
                            <th>Chosen Regimen</th>
                            <th>Expected Response</th>
                            <th>Confidence</th>
                            <th>Guideline Alignment</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attempt in decision_logs %}
                            <tr>
                                <td>{{ attempt.submitted|date:"Y-m-d H:i" }}</td>
                                <td>{{ attempt.user.username|default:"anonymous" }}</td>
                                <td>{{ attempt.selected_regimen.name|default:"‚Äì" }}</td>
                                <td>{{ attempt.get_predicted_response_display|default:"‚Äì" }}</td>
                                <td>{{ attempt.confidence }}%</td>
                                <td>
                                    {% if attempt.is_guideline_aligned %}
                                        <span class="badge bg-success">Aligned</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Review</span>
                                    {% endif %}
                                </td>
                                <td>{{ attempt.notes|default:"‚Äì" }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if decision_logs_count > 20 %}
                <div class="px-3 py-2 text-muted small">
                    <span class="t-en">Showing latest 20 of {{ decision_logs_count }}.</span>
                    <span class="t-it">Mostro le ultime 20 di {{ decision_logs_count }}.</span>
                </div>
            {% endif %}
        {% else %}
            <p class="m-3 text-muted">
                <span class="t-en">No decisions recorded yet.</span>
                <span class="t-it">Nessuna decisione registrata.</span>
            </p>
        {% endif %}
    </div>
</div>

{% if scenario.guideline_notes %}
    <div class="card shadow-sm">
        <div class="card-header">
            <h2 class="h5 mb-0">Guideline Notes</h2>
        </div>
        <div class="card-body">
            <p class="mb-0">{{ scenario.guideline_notes }}</p>
        </div>
    </div>
{% endif %}

{% if is_editor %}
<div class="offcanvas offcanvas-end" tabindex="-1" id="manageRegimensOffcanvas" aria-labelledby="manageRegimensOffcanvasLabel">
    <div class="offcanvas-header">
        <h2 class="h5 mb-0" id="manageRegimensOffcanvasLabel">Manage Guideline Regimens</h2>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="guideline-regimens-offcanvas-body">
            {% include "simulator/_guideline_regimens_card.html" with scenario=scenario regimens=recommended_regimens available_regimens=available_regimens target_id="guideline-regimens-offcanvas-body" allow_multiple=True %}
        </div>
    </div>
</div>
{% endif %}

{% if request.user.is_authenticated %}
<div class="collapse {% if game_mode or prefill_twin %}show{% endif %}" id="simulateScenarioPanel">
    <div class="card shadow-sm mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h6 mb-0">
                <span class="t-en">Simulation Panel</span>
                <span class="t-it">Pannello Simulazione</span>
            </h2>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#simulateScenarioPanel" aria-label="Close">&times;</button>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3" role="alert">
                <div class="small">
                    <span class="t-en"><strong>Where are results?</strong> After you click <strong>Run simulation</strong>, results appear on this page in the right column under <strong>Simulation Results</strong>.</span>
                    <span class="t-it"><strong>Dove sono i risultati?</strong> Dopo aver cliccato <strong>Esegui simulazione</strong>, i risultati appaiono in questa pagina nella colonna a destra sotto <strong>Risultati della simulazione</strong>.</span>
                </div>
            </div>
            {% include "simulator/_onboarding.html" %}
                        {% include "simulator/_simulation_form.html" with form=simulation_parameter_form scenario=scenario drug_profiles=drug_profiles helptext_it=sim_form_help_it helptext_en=sim_form_help_en is_editor=is_editor preset_descriptions=preset_descriptions game_mode=game_mode %}
        </div>
    </div>
</div>
{% endif %}

<script>
(() => {
    const setStatus = (enHtml, itHtml, klass = 'alert-light') => {
        const el = document.getElementById('simulation-status');
        if (!el) return;
        el.classList.remove('alert-light', 'alert-info', 'alert-warning', 'alert-danger', 'alert-success');
        el.classList.add(klass);
        const en = el.querySelector('.t-en');
        const it = el.querySelector('.t-it');
        if (en) en.innerHTML = enHtml;
        if (it) it.innerHTML = itHtml;
    };

    const updateBest = () => {
        const node = document.getElementById('game-score');
        if (!node) return;
        const scenarioId = node.getAttribute('data-game-scenario');
        const scoreRaw = node.getAttribute('data-game-score');
        if (!scenarioId || !scoreRaw) return;
        const score = parseInt(scoreRaw, 10);
        if (!Number.isFinite(score)) return;
        const key = `mm.game.best.${scenarioId}`;
        const prev = parseInt(localStorage.getItem(key) || '', 10);
        const best = Number.isFinite(prev) ? Math.max(prev, score) : score;
        localStorage.setItem(key, String(best));
        const bestEl = document.getElementById('game-best-score');
        if (bestEl) bestEl.textContent = best;
    };

    document.body.addEventListener('htmx:beforeRequest', (event) => {
        if (event.detail && event.detail.target && event.detail.target.id === 'simulation-results') {
            setStatus(
                '<strong>Status:</strong> Running simulation‚Ä¶ this will create a new row in ‚ÄúSimulation Runs‚Äù.',
                '<strong>Stato:</strong> Simulazione in corso‚Ä¶ verr√† aggiunta una nuova riga in ‚ÄúEsecuzioni Simulazione‚Äù.',
                'alert-info'
            );
        }
    });

    document.body.addEventListener('htmx:responseError', (event) => {
        if (event.detail && event.detail.target && event.detail.target.id === 'simulation-results') {
            setStatus(
                '<strong>Status:</strong> Error while running. Try again or adjust inputs.',
                '<strong>Stato:</strong> Errore durante l‚Äôesecuzione. Riprova o modifica gli input.',
                'alert-danger'
            );
        }
    });

    document.body.addEventListener('htmx:afterSwap', (event) => {
        if (event.detail && event.detail.target && event.detail.target.id === 'simulation-results') {
            updateBest();
            const now = new Date();
            setStatus(
                `<strong>Status:</strong> Completed at ${now.toLocaleTimeString()}. Results updated below.`,
                `<strong>Stato:</strong> Completato alle ${now.toLocaleTimeString()}. Risultati aggiornati qui sotto.`,
                'alert-success'
            );
            // Make results discoverable: scroll into view after a run.
            const resultsEl = document.getElementById('simulation-results');
            if (resultsEl && typeof resultsEl.scrollIntoView === 'function') {
                resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    });

    // Initial render
    updateBest();
})();
</script>
{% endblock %}
