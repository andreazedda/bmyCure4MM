<div id="simulation-form-container">
    <!-- Align simulation form indicator with embedded progress bar -->
    <div class="accordion mb-3" id="modelOverview">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOverview">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOverview" aria-expanded="false" aria-controls="collapseOverview">
                    üß¨ About This Simulation
                </button>
            </h2>
            <div id="collapseOverview" class="accordion-collapse collapse" aria-labelledby="headingOverview" data-bs-parent="#modelOverview">
                <div class="accordion-body small text-muted">
                    This model couples pharmacokinetic (drug concentration) and pharmacodynamic (drug effect) equations to estimate how malignant and healthy plasma cells evolve when exposed to Lenalidomide, Bortezomib, and Daratumumab. Adjust the parameters to explore induction, consolidation, or maintenance strategies. Results support decision making and do not constitute medical advice.
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mb-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#referenceRangesModal">
            Reference ranges
        </button>
    </div>

    <form id="simulation-parameters-form"
          method="post"
          hx-post="{% url 'simulator:scenario_simulate' scenario.pk %}"
          hx-target="#simulation-results"
          hx-swap="outerHTML"
          hx-indicator="#simulation-indicator"
          novalidate>
        {% csrf_token %}
        {% if warnings %}
            <div class="alert alert-warning" role="alert">
                {% for warning in warnings %}
                    <div>{{ warning }}</div>
                {% endfor %}
            </div>
        {% endif %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">{{ form.non_field_errors }}</div>
        {% endif %}
        {% for field in form %}
            <div class="mb-3">
                <label class="form-label" for="id_{{ field.name }}">{{ field.label }}{% if field.field.required %}<span class="text-danger"> *</span>{% endif %}
                    {% if field.help_text %}
                        <span class="ms-1 text-muted" role="img" aria-label="Help" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ field.help_text }}">&#9432;</span>
                    {% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% if field.errors %}
                    <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                {% endif %}
            </div>
        {% endfor %}
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Run Simulation</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Close</button>
        </div>
        <p class="mt-3 small text-muted mb-0">All values are for exploratory modeling only and should be interpreted alongside clinical judgement and institutional guidance.</p>
    </form>

    <div class="modal fade" id="referenceRangesModal" tabindex="-1" aria-labelledby="referenceRangesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="h5 modal-title" id="referenceRangesLabel">Reference Ranges</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Typical parameter ranges compiled from NCCN 2025 guidance and peer-reviewed pharmacology studies.</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Typical range</th>
                                    <th scope="col">Reference</th>
                                </tr>
                            </thead>
                            <tbody class="small">
                                <tr>
                                    <td>Initial tumor cells</td>
                                    <td>10‚Åπ ‚Äì 10¬π¬≤ cells</td>
                                    <td>NCCN MM v3.2025</td>
                                </tr>
                                <tr>
                                    <td>Lenalidomide dose</td>
                                    <td>25 mg daily (21/28 days)</td>
                                    <td>IMiD prescribing info</td>
                                </tr>
                                <tr>
                                    <td>Bortezomib dose</td>
                                    <td>1.3 mg/m¬≤ weekly or biweekly</td>
                                    <td>Velcade¬Æ PI 2024</td>
                                </tr>
                                <tr>
                                    <td>Daratumumab dose</td>
                                    <td>16 mg/kg IV (loading)</td>
                                    <td>Darzalex¬Æ PI 2024</td>
                                </tr>
                                <tr>
                                    <td>Tumor growth rate</td>
                                    <td>0.015 ‚Äì 0.03 day‚Åª¬π</td>
                                    <td>Rajkumar et al., Blood 2022</td>
                                </tr>
                                <tr>
                                    <td>Healthy growth rate</td>
                                    <td>0.01 ‚Äì 0.02 day‚Åª¬π</td>
                                    <td>Bone marrow recovery studies</td>
                                </tr>
                                <tr>
                                    <td>Interaction strength</td>
                                    <td>0.0 ‚Äì 0.15 (dimensionless)</td>
                                    <td>Model calibration (internal)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const thresholds = {
        lenalidomide_dose: 40,
        bortezomib_dose: 1.5,
        daratumumab_dose: 16,
        interaction_strength: 0.15,
    };
    const applyWarnings = (input) => {
        const limit = thresholds[input.name];
        if (limit === undefined) {
            input.classList.remove('is-warning');
            return;
        }
        const value = parseFloat(input.value);
        if (Number.isFinite(value) && value > limit) {
            input.classList.add('is-warning');
        } else {
            input.classList.remove('is-warning');
        }
    };
    document.querySelectorAll('#simulation-parameters-form .form-control').forEach((input) => {
        applyWarnings(input);
        input.addEventListener('input', () => applyWarnings(input));
        input.addEventListener('blur', () => applyWarnings(input));
    });
})();
</script>
