{% load simulator_extras %}
<div id="simulation-form-container">
    <div class="d-flex justify-content-end mb-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#referenceRangesModal">
            Reference ranges
        </button>
    </div>
    <form id="simulation-parameters-form"
          method="post"
          hx-post="{% url 'simulator:scenario_simulate' scenario.pk %}"
          hx-target="#simulation-results"
          hx-indicator="#simulation-indicator"
          hx-disabled-elt="button, input, select, textarea">
        {% csrf_token %}
        {% if warnings %}
            <div class="alert alert-warning" role="alert">
                {% for warning in warnings %}
                    <div>{{ warning }}</div>
                {% endfor %}
            </div>
        {% endif %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">{{ form.non_field_errors }}</div>
        {% endif %}

        <fieldset class="mb-4">
            <legend class="h6 mb-3">1. <span class="t-en">Baseline</span><span class="t-it">Baseline</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Baseline locks labs, preset and tumor burden before dosage.</span>
                <span class="t-it">La baseline definisce esami, preset e carico tumorale prima del dosaggio.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.preset help_en=helptext_en|dict_get:'preset' help_it=helptext_it|dict_get:'preset' %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.baseline_tumor_cells help_en=helptext_en|dict_get:'baseline_tumor_cells' help_it=helptext_it|dict_get:'baseline_tumor_cells' unit="cells" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.baseline_healthy_cells help_en=helptext_en|dict_get:'baseline_healthy_cells' help_it=helptext_it|dict_get:'baseline_healthy_cells' unit="cells" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.creatinine_clearance help_en=helptext_en|dict_get:'creatinine_clearance' help_it=helptext_it|dict_get:'creatinine_clearance' unit="ml/min" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.neuropathy_grade help_en=helptext_en|dict_get:'neuropathy_grade' help_it=helptext_it|dict_get:'neuropathy_grade' %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.anc help_en=helptext_en|dict_get:'anc' help_it=helptext_it|dict_get:'anc' unit="×10⁹/L" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.platelets help_en=helptext_en|dict_get:'platelets' help_it=helptext_it|dict_get:'platelets' unit="×10⁹/L" %}
                </div>
                <div class="col-12">
                    <div class="form-check form-switch">
                        {{ form.pregnancy }}
                        <label class="form-check-label" for="{{ form.pregnancy.id_for_label }}">{{ form.pregnancy.label }}</label>
                    </div>
                    <div class="form-text">
                        <span class="t-en">{{ helptext_en|dict_get:'pregnancy' }}</span>
                        <span class="t-it">{{ helptext_it|dict_get:'pregnancy' }}</span>
                    </div>
                    {% if form.pregnancy.errors %}
                        <div class="invalid-feedback d-block">{{ form.pregnancy.errors|striptags }}</div>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6 mb-3">2. <span class="t-en">Doses & Schedule</span><span class="t-it">Dosi & Schedula</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Stay within preset ranges; schedules follow validated clinical patterns.</span>
                <span class="t-it">Rimani nei range dei preset; le schedulazioni seguono pattern clinici validati.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    {% with profile=drug_profiles.lenalidomide %}
                        {% if profile %}
                            {% include "simulator/_form_field.html" with field=form.lenalidomide_dose help_en=helptext_en|dict_get:'lenalidomide_dose' help_it=helptext_it|dict_get:'lenalidomide_dose' unit="mg" append_en=profile.range_en append_it=profile.range_it %}
                        {% else %}
                            {% include "simulator/_form_field.html" with field=form.lenalidomide_dose help_en=helptext_en|dict_get:'lenalidomide_dose' help_it=helptext_it|dict_get:'lenalidomide_dose' unit="mg" %}
                        {% endif %}
                    {% endwith %}
                </div>
                <div class="col-12 col-md-4">
                    {% with profile=drug_profiles.bortezomib %}
                        {% if profile %}
                            {% include "simulator/_form_field.html" with field=form.bortezomib_dose help_en=helptext_en|dict_get:'bortezomib_dose' help_it=helptext_it|dict_get:'bortezomib_dose' unit="mg/m²" append_en=profile.range_en append_it=profile.range_it %}
                        {% else %}
                            {% include "simulator/_form_field.html" with field=form.bortezomib_dose help_en=helptext_en|dict_get:'bortezomib_dose' help_it=helptext_it|dict_get:'bortezomib_dose' unit="mg/m²" %}
                        {% endif %}
                    {% endwith %}
                </div>
                <div class="col-12 col-md-4">
                    {% with profile=drug_profiles.daratumumab %}
                        {% if profile %}
                            {% include "simulator/_form_field.html" with field=form.daratumumab_dose help_en=helptext_en|dict_get:'daratumumab_dose' help_it=helptext_it|dict_get:'daratumumab_dose' unit="mg/kg" append_en=profile.range_en append_it=profile.range_it %}
                        {% else %}
                            {% include "simulator/_form_field.html" with field=form.daratumumab_dose help_en=helptext_en|dict_get:'daratumumab_dose' help_it=helptext_it|dict_get:'daratumumab_dose' unit="mg/kg" %}
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            <div class="alert alert-info novice-tip mt-3 mb-0">
                <span class="t-en"><strong>Why it matters:</strong> Higher AUC tends to increase toxicity—balance exposure vs efficacy.</span>
                <span class="t-it"><strong>Perché conta:</strong> AUC più alta aumenta la tossicità—bilancia esposizione ed efficacia.</span>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6 mb-3">3. <span class="t-en">Horizon & Uncertainty</span><span class="t-it">Orizzonte & Incertezza</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Bigger cohorts show variability bands but take longer. Start small, then scale.</span>
                <span class="t-it">Coorti più grandi mostrano la variabilità ma richiedono più tempo. Inizia piccolo, poi scala.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.time_horizon help_en=helptext_en|dict_get:'time_horizon' help_it=helptext_it|dict_get:'time_horizon' unit="days" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.cohort_size help_en=helptext_en|dict_get:'cohort_size' help_it=helptext_it|dict_get:'cohort_size' %}
                </div>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6 mb-3">4. <span class="t-en">Advanced</span><span class="t-it">Avanzate</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Tweak biology and interactions cautiously; pair with Patient Twin for lab-driven values.</span>
                <span class="t-it">Modifica biologia e interazioni con cautela; usa il Gemello Paziente per valori guidati dai lab.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.tumor_growth_rate help_en=helptext_en|dict_get:'tumor_growth_rate' help_it=helptext_it|dict_get:'tumor_growth_rate' unit="day⁻¹" %}
                </div>
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.healthy_growth_rate help_en=helptext_en|dict_get:'healthy_growth_rate' help_it=helptext_it|dict_get:'healthy_growth_rate' unit="day⁻¹" %}
                </div>
                <div class="col-12 col-md-4">
                    <div id="interaction-strength-wrapper">
                        {% include "simulator/_form_field.html" with field=form.interaction_strength help_en=helptext_en|dict_get:'interaction_strength' help_it=helptext_it|dict_get:'interaction_strength' %}
                    </div>
                    <span id="interaction-strength-badge" class="badge bg-success"></span>
                </div>
                <div class="col-12 col-md-6">
                    <div class="form-check form-switch">
                        {{ form.use_twin }}
                        <label class="form-check-label" for="{{ form.use_twin.id_for_label }}">
                            <span class="t-en">Use Patient Twin (auto-derive biology)</span>
                            <span class="t-it">Usa Gemello Paziente (deriva dai lab)</span>
                        </label>
                    </div>
                    <div class="form-text">
                        <span class="t-en">{{ helptext_en|dict_get:'use_twin' }}</span>
                        <span class="t-it">{{ helptext_it|dict_get:'use_twin' }}</span>
                    </div>
                    {% if form.use_twin.errors %}
                        <div class="invalid-feedback d-block">{{ form.use_twin.errors|striptags }}</div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.seed help_en=helptext_en|dict_get:'seed' help_it=helptext_it|dict_get:'seed' %}
                </div>
            </div>
        </fieldset>

        <div class="d-flex flex-wrap align-items-center gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#simulateScenarioPanel" aria-label="Close">
                <span class="t-en">Close</span><span class="t-it">Chiudi</span>
            </button>
            <button type="reset" class="btn btn-outline-dark">
                <span class="t-en">Reset to preset</span><span class="t-it">Reset al preset</span>
            </button>
            <button type="submit" class="btn btn-primary">
                <span class="t-en">Run simulation</span><span class="t-it">Esegui simulazione</span>
            </button>
            {% if is_editor %}
                <button type="button"
                        class="btn btn-outline-primary"
                        hx-post="{% url 'simulator:run_experiment' scenario.pk %}"
                        hx-include="#simulation-parameters-form"
                        hx-target="#pareto-panel"
                        hx-indicator="#simulation-indicator">
                    <span class="t-en">Optimize regimen</span><span class="t-it">Ottimizza regime</span>
                </button>
            {% endif %}
            <div id="simulation-indicator" class="htmx-indicator spinner-border spinner-border-sm text-primary d-none" role="status" aria-hidden="true"></div>
            <span class="text-muted small" id="last-run"></span>
        </div>
    </form>

    <div class="modal fade" id="referenceRangesModal" tabindex="-1" aria-labelledby="referenceRangesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="h5 modal-title" id="referenceRangesLabel">Reference Ranges</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Typical parameter ranges compiled from NCCN 2025 guidance and peer-reviewed studies.</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Typical range</th>
                                    <th scope="col">Reference</th>
                                </tr>
                            </thead>
                            <tbody class="small">
                                <tr>
                                    <td>Initial tumor cells</td>
                                    <td>10⁹ – 10¹² cells</td>
                                    <td>NCCN MM v3.2025</td>
                                </tr>
                                <tr>
                                    <td>Lenalidomide dose</td>
                                    <td>25 mg daily (21/28 days)</td>
                                    <td>IMiD prescribing info</td>
                                </tr>
                                <tr>
                                    <td>Bortezomib dose</td>
                                    <td>1.3 mg/m² weekly or biweekly</td>
                                    <td>Velcade® PI 2024</td>
                                </tr>
                                <tr>
                                    <td>Daratumumab dose</td>
                                    <td>16 mg/kg IV (loading)</td>
                                    <td>Darzalex® PI 2024</td>
                                </tr>
                                <tr>
                                    <td>Tumor growth rate</td>
                                    <td>0.015 – 0.03 day⁻¹</td>
                                    <td>Rajkumar et al., Blood 2022</td>
                                </tr>
                                <tr>
                                    <td>Healthy growth rate</td>
                                    <td>0.01 – 0.02 day⁻¹</td>
                                    <td>Bone marrow recovery studies</td>
                                </tr>
                                <tr>
                                    <td>Interaction strength</td>
                                    <td>0.0 – 0.15 (dimensionless)</td>
                                    <td>Model calibration (internal)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function () {
    const warningLimits = {
        lenalidomide_dose: 40,
        bortezomib_dose: 1.5,
        daratumumab_dose: 16,
        interaction_strength: 0.2,
    };
    const badge = document.getElementById('interaction-strength-badge');
    const interactionField = document.getElementById('{{ form.interaction_strength.id_for_label }}');

    const updateBadge = () => {
        if (!badge || !interactionField) return;
        const value = parseFloat(interactionField.value);
        const lang = getCurrentLang ? getCurrentLang() : 'en';
        let textEn = 'Safe';
        let textIt = 'Sicuro';
        let cls = 'bg-success';
        if (Number.isFinite(value) && value >= 0.1 && value <= 0.2) {
            textEn = 'Borderline';
            textIt = 'Attenzione';
            cls = 'bg-warning text-dark';
        } else if (Number.isFinite(value) && value > 0.2) {
            textEn = 'Unsafe';
            textIt = 'Rischioso';
            cls = 'bg-danger';
        }
        badge.className = `badge ${cls}`;
        badge.textContent = lang === 'it' ? textIt : textEn;
    };

    const applyWarnings = (input) => {
        const limit = warningLimits[input.name];
        if (limit === undefined) {
            input.classList.remove('is-warning');
            return;
        }
        const value = parseFloat(input.value);
        if (Number.isFinite(value) && value > limit) {
            input.classList.add('is-warning');
        } else {
            input.classList.remove('is-warning');
        }
    };

    document.querySelectorAll('#simulation-parameters-form .form-control').forEach((input) => {
        applyWarnings(input);
        input.addEventListener('input', () => {
            applyWarnings(input);
            if (input === interactionField) {
                updateBadge();
            }
        });
        input.addEventListener('blur', () => applyWarnings(input));
    });

    if (interactionField) {
        updateBadge();
    }

    document.getElementById('simulation-parameters-form').addEventListener('reset', () => {
        setTimeout(() => {
            document.querySelectorAll('#simulation-parameters-form .form-control').forEach(applyWarnings);
            updateBadge();
        }, 0);
    });

    document.body.addEventListener('htmx:afterRequest', (event) => {
        if (!event.detail || !event.detail.target) {
            return;
        }
        if (event.detail.target.id === 'simulation-results') {
            const badgeEl = document.getElementById('last-run');
            if (badgeEl) {
                const lang = getCurrentLang ? getCurrentLang() : 'en';
                const label = lang === 'it' ? 'Ultima esecuzione: ' : 'Last run: ';
                badgeEl.textContent = `${label}${new Date().toLocaleTimeString()}`;
            }
            event.detail.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
})();
</script>
