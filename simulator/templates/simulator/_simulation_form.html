{% load simulator_extras %}
<div id="simulation-form-container">
    <div class="d-flex justify-content-end mb-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#referenceRangesModal">
            Reference ranges
        </button>
    </div>
    <form id="simulation-parameters-form"
          method="post"
          hx-post="{% url 'simulator:scenario_simulate' scenario.pk %}"
          hx-target="#simulation-results"
          hx-indicator="#simulation-indicator"
          hx-disabled-elt="button, input, select, textarea">
        {% csrf_token %}
        {% if game_mode %}
            <input type="hidden" name="game_mode" value="1">
            <div class="alert alert-dark mb-3" role="alert">
                <strong>üéÆ <span class="t-en">Game Mode</span><span class="t-it">Modalit√† Gioco</span></strong>
                <div class="small">
                    <span class="t-en">Goal: maximize tumor reduction while keeping healthy loss low. Each run updates your score.</span>
                    <span class="t-it">Obiettivo: massimizza la riduzione tumorale mantenendo bassa la perdita di cellule sane. Ogni run aggiorna il punteggio.</span>
                </div>
            </div>
        {% endif %}
        {% if game_mode %}
            <input type="hidden" name="game_mode" value="1">
        {% endif %}
        {% if warnings %}
            <div class="alert alert-warning" role="alert">
                {% for warning in warnings %}
                    <div>{{ warning }}</div>
                {% endfor %}
            </div>
        {% endif %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">{{ form.non_field_errors }}</div>
        {% endif %}

        <fieldset class="mb-4">
            <legend class="h6 mb-3">1. <span class="t-en">Baseline</span><span class="t-it">Baseline</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Baseline locks labs, preset and tumor burden before dosage.</span>
                <span class="t-it">La baseline definisce esami, preset e carico tumorale prima del dosaggio.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.preset help_en=helptext_en|dict_get:'preset' help_it=helptext_it|dict_get:'preset' help_slug="quickstart" %}
                    <div id="preset-explainer" class="alert alert-primary mt-2 d-none">
                        <h6 class="story-title fw-bold mb-2"></h6>
                        <div class="story-background mb-2"></div>
                        <div class="story-challenge alert alert-warning mb-2"></div>
                        <div class="story-why mb-2">
                            <strong>üí° <span class="t-en">Why these drugs?</span><span class="t-it">Perch√© questi farmaci?</span></strong>
                            <p class="story-why-text mb-0"></p>
                        </div>
                        <div class="story-outcome mb-2">
                            <strong>üéØ <span class="t-en">Expected Outcome:</span><span class="t-it">Risultato Atteso:</span></strong>
                            <p class="story-outcome-text mb-0"></p>
                        </div>
                        <details class="story-learning">
                            <summary class="fw-semibold" style="cursor: pointer;">
                                üìö <span class="t-en">Learning Points (click to expand)</span><span class="t-it">Punti di Apprendimento (clicca per espandere)</span>
                            </summary>
                            <ul class="story-learning-list mt-2 mb-0"></ul>
                        </details>
                        <small class="d-block mt-2">
                            <a href="#" data-help="quickstart">
                                <span class="t-en">üìñ More guidance</span>
                                <span class="t-it">üìñ Pi√π indicazioni</span>
                            </a>
                        </small>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.baseline_tumor_cells help_en=helptext_en|dict_get:'baseline_tumor_cells' help_it=helptext_it|dict_get:'baseline_tumor_cells' unit="cells" help_slug="quickstart" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.baseline_healthy_cells help_en=helptext_en|dict_get:'baseline_healthy_cells' help_it=helptext_it|dict_get:'baseline_healthy_cells' unit="cells" help_slug="quickstart" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.creatinine_clearance help_en=helptext_en|dict_get:'creatinine_clearance' help_it=helptext_it|dict_get:'creatinine_clearance' unit="ml/min" help_slug="doses" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.neuropathy_grade help_en=helptext_en|dict_get:'neuropathy_grade' help_it=helptext_it|dict_get:'neuropathy_grade' help_slug="doses" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.anc help_en=helptext_en|dict_get:'anc' help_it=helptext_it|dict_get:'anc' unit="√ó10‚Åπ/L" help_slug="doses" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.platelets help_en=helptext_en|dict_get:'platelets' help_it=helptext_it|dict_get:'platelets' unit="√ó10‚Åπ/L" help_slug="doses" %}
                </div>
                <div class="col-12">
                    <div class="form-check form-switch">
                        {{ form.pregnancy }}
                        <label class="form-check-label" for="{{ form.pregnancy.id_for_label }}">
                            {{ form.pregnancy.label }}
                            <a href="#" class="ms-1 small" data-help="pregnancy" aria-label="Help">?</a>
                        </label>
                    </div>
                    <div class="form-text">
                        <span class="t-en">{{ helptext_en|dict_get:'pregnancy' }}</span>
                        <span class="t-it">{{ helptext_it|dict_get:'pregnancy' }}</span>
                    </div>
                    {% if form.pregnancy.errors %}
                        <div class="invalid-feedback d-block">{{ form.pregnancy.errors|striptags }}</div>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6 mb-3">2. <span class="t-en">Doses & Schedule</span><span class="t-it">Dosi & Schedula</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Stay within preset ranges; schedules follow validated clinical patterns.</span>
                <span class="t-it">Rimani nei range dei preset; le schedulazioni seguono pattern clinici validati.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    {% with profile=drug_profiles.lenalidomide %}
                        {% include "simulator/_form_field.html" with field=form.lenalidomide_dose help_en=helptext_en|dict_get:'lenalidomide_dose' help_it=helptext_it|dict_get:'lenalidomide_dose' unit="mg" append_en=profile|dict_get:'range_en' append_it=profile|dict_get:'range_it' help_slug="dose_ranges_lenalidomide" add_badge=True %}
                    {% endwith %}
                </div>
                <div class="col-12 col-md-4">
                    {% with profile=drug_profiles.bortezomib %}
                        {% include "simulator/_form_field.html" with field=form.bortezomib_dose help_en=helptext_en|dict_get:'bortezomib_dose' help_it=helptext_it|dict_get:'bortezomib_dose' unit="mg/m¬≤" append_en=profile|dict_get:'range_en' append_it=profile|dict_get:'range_it' help_slug="dose_ranges_bortezomib" add_badge=True %}
                    {% endwith %}
                </div>
                <div class="col-12 col-md-4">
                    {% with profile=drug_profiles.daratumumab %}
                        {% include "simulator/_form_field.html" with field=form.daratumumab_dose help_en=helptext_en|dict_get:'daratumumab_dose' help_it=helptext_it|dict_get:'daratumumab_dose' unit="mg/kg" append_en=profile|dict_get:'range_en' append_it=profile|dict_get:'range_it' help_slug="dose_ranges_daratumumab" add_badge=True %}
                    {% endwith %}
                </div>
            </div>
            <div class="alert alert-info novice-tip mt-3 mb-0">
                <span class="t-en"><strong>Why it matters:</strong> Higher AUC tends to increase toxicity‚Äîbalance exposure vs efficacy.</span>
                <span class="t-it"><strong>Perch√© conta:</strong> AUC pi√π alta aumenta la tossicit√†‚Äîbilancia esposizione ed efficacia.</span>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6 mb-3">3. <span class="t-en">Horizon & Uncertainty</span><span class="t-it">Orizzonte & Incertezza</span></legend>
            <div class="novice-tip alert alert-info mb-3">
                <span class="t-en">Bigger cohorts show variability bands but take longer. Start small, then scale.</span>
                <span class="t-it">Coorti pi√π grandi mostrano la variabilit√† ma richiedono pi√π tempo. Inizia piccolo, poi scala.</span>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.time_horizon help_en=helptext_en|dict_get:'time_horizon' help_it=helptext_it|dict_get:'time_horizon' unit="days" help_slug="horizon_cohort" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.cohort_size help_en=helptext_en|dict_get:'cohort_size' help_it=helptext_it|dict_get:'cohort_size' help_slug="horizon_cohort" %}
                </div>
            </div>
        </fieldset>

        <fieldset class="mb-4">
            <legend class="h6 mb-3">
                4. <span class="t-en">Advanced &amp; Twin</span><span class="t-it">Avanzate &amp; Gemello</span>
                <a href="{% url 'simulator:interactive_tutorial' %}" class="btn btn-sm btn-outline-info ms-2" target="_blank">
                    <span class="t-en">üéì How to use Twin?</span>
                    <span class="t-it">üéì Come usare il Twin?</span>
                </a>
            </legend>
            <div class="novice-tip alert alert-info mb-3">
                <div class="mb-2">
                    <span class="t-en">Tweak biology and interactions cautiously; pair with Patient Twin for lab-driven values.</span>
                    <span class="t-it">Modifica biologia e interazioni con cautela; usa il Gemello Paziente per valori guidati dai lab.</span>
                </div>
                <div class="small">
                    <strong class="t-en">‚ö° Quick Twin Setup:</strong>
                    <strong class="t-it">‚ö° Setup Rapido Twin:</strong>
                    <span class="t-en">1Ô∏è‚É£ Create Patient (Clinic) ‚Üí 2Ô∏è‚É£ Add Assessment with labs ‚Üí 3Ô∏è‚É£ Enable Twin below ‚Üí 4Ô∏è‚É£ Select Assessment ‚Üí 5Ô∏è‚É£ Choose "Auto" mode ‚Üí 6Ô∏è‚É£ Run!</span>
                    <span class="t-it">1Ô∏è‚É£ Crea Paziente (Clinica) ‚Üí 2Ô∏è‚É£ Aggiungi Assessment con lab ‚Üí 3Ô∏è‚É£ Abilita Twin qui sotto ‚Üí 4Ô∏è‚É£ Seleziona Assessment ‚Üí 5Ô∏è‚É£ Scegli modo "Auto" ‚Üí 6Ô∏è‚É£ Lancia!</span>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.tumor_growth_rate help_en=helptext_en|dict_get:'tumor_growth_rate' help_it=helptext_it|dict_get:'tumor_growth_rate' unit="day‚Åª¬π" help_slug="twin" %}
                </div>
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.healthy_growth_rate help_en=helptext_en|dict_get:'healthy_growth_rate' help_it=helptext_it|dict_get:'healthy_growth_rate' unit="day‚Åª¬π" help_slug="twin" %}
                </div>
                <div class="col-12 col-md-4">
                    <div id="interaction-strength-wrapper">
                        {% include "simulator/_form_field.html" with field=form.interaction_strength help_en=helptext_en|dict_get:'interaction_strength' help_it=helptext_it|dict_get:'interaction_strength' help_slug="interaction_strength" add_badge=True %}
                    </div>
                    <span id="interaction-strength-badge" class="badge bg-success"></span>
                </div>
                <div class="col-12 col-md-6">
                    <div class="form-check form-switch">
                        {{ form.use_twin }}
                        <label class="form-check-label" for="{{ form.use_twin.id_for_label }}">
                            <span class="t-en">Use Patient Twin (auto-derive biology)</span>
                            <span class="t-it">Usa Gemello Paziente (deriva dai lab)</span>
                            <a href="#" class="ms-1 small" data-help="use_twin" aria-label="Help">?</a>
                        </label>
                    </div>
                    <div class="form-text">
                        <span class="t-en">{{ helptext_en|dict_get:'use_twin' }}</span>
                        <span class="t-it">{{ helptext_it|dict_get:'use_twin' }}</span>
                    </div>
                    {% if form.use_twin.errors %}
                        <div class="invalid-feedback d-block">{{ form.use_twin.errors|striptags }}</div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.twin_assessment_id help_en="Select the Assessment snapshot used for Patient Twin (create it in Clinic ‚Üí Patient ‚Üí Add Assessment)." help_it="Seleziona lo snapshot (Assessment) usato dal Gemello Paziente (si crea in Clinica ‚Üí Paziente ‚Üí Aggiungi Assessment)." help_slug="twin" %}
                    <div class="form-text">
                        <a href="{% url 'simulator:visibility_diagnostics' %}" target="_blank">
                            <span class="t-en">Why don't I see all assessments?</span>
                            <span class="t-it">Perch√© non vedo tutti gli assessment?</span>
                        </a>
                    </div>
                    {% if form.twin_assessment_id.field.disabled %}
                        <div class="alert alert-warning mt-2 mb-0" role="alert">
                            <span class="t-en"><strong>No accessible assessments.</strong> Load demo data (DEMO) or create a patient + assessment you own.</span>
                            <span class="t-it"><strong>Nessun assessment accessibile.</strong> Carica i dati demo (DEMO) oppure crea un paziente + assessment di cui sei owner.</span>
                        </div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.twin_biology_mode help_en="Auto derives biology from the selected Assessment; Manual keeps the values you enter below." help_it="Auto deriva la biologia dall'Assessment selezionato; Manual mantiene i valori inseriti qui sotto." help_slug="twin" %}
                </div>
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.carrying_capacity_tumor help_en="Twin-driven unless set to Manual." help_it="Derivato dal Twin salvo modalit√† Manual." unit="cells" help_slug="twin" %}
                </div>
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.carrying_capacity_healthy help_en="Twin-driven unless set to Manual." help_it="Derivato dal Twin salvo modalit√† Manual." unit="cells" help_slug="twin" %}
                </div>
                <div class="col-12 col-md-4">
                    {% include "simulator/_form_field.html" with field=form.immune_compromise_index help_en="Twin-driven unless set to Manual." help_it="Derivato dal Twin salvo modalit√† Manual." help_slug="twin" %}
                </div>
                <div class="col-12 col-md-6">
                    {% include "simulator/_form_field.html" with field=form.seed help_en=helptext_en|dict_get:'seed' help_it=helptext_it|dict_get:'seed' help_slug="quickstart" %}
                </div>
            </div>
        </fieldset>

        <div class="d-flex flex-wrap align-items-center gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#simulateScenarioPanel" aria-label="Close">
                <span class="t-en">Close</span><span class="t-it">Chiudi</span>
            </button>
            <button type="reset" class="btn btn-outline-dark">
                <span class="t-en">Reset to preset</span><span class="t-it">Reset al preset</span>
            </button>
            <button type="submit" class="btn btn-primary novice-submit">
                <span class="t-en">Run simulation</span><span class="t-it">Esegui simulazione</span>
            </button>
            {% if is_editor %}
                <button type="button"
                        class="btn btn-outline-primary novice-submit"
                        hx-post="{% url 'simulator:run_experiment' scenario.pk %}"
                        hx-include="#simulation-parameters-form"
                        hx-target="#pareto-panel"
                        hx-indicator="#simulation-indicator"
                        data-audit="optimize_click">
                    <span class="t-en">Optimize regimen</span><span class="t-it">Ottimizza regime</span>
                </button>
            {% endif %}
            <div id="simulation-indicator" class="htmx-indicator spinner-border spinner-border-sm text-primary d-none" role="status" aria-hidden="true"></div>
            <span class="text-muted small" id="last-run"></span>
        </div>
    </form>

    <div class="modal fade" id="referenceRangesModal" tabindex="-1" aria-labelledby="referenceRangesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="h5 modal-title" id="referenceRangesLabel">Reference Ranges</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Typical parameter ranges compiled from NCCN 2025 guidance and peer-reviewed studies.</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Typical range</th>
                                    <th scope="col">Reference</th>
                                </tr>
                            </thead>
                            <tbody class="small">
                                <tr>
                                    <td>Initial tumor cells</td>
                                    <td>10‚Åπ ‚Äì 10¬π¬≤ cells</td>
                                    <td>NCCN MM v3.2025</td>
                                </tr>
                                <tr>
                                    <td>Lenalidomide dose</td>
                                    <td>25 mg daily (21/28 days)</td>
                                    <td>IMiD prescribing info</td>
                                </tr>
                                <tr>
                                    <td>Bortezomib dose</td>
                                    <td>1.3 mg/m¬≤ weekly or biweekly</td>
                                    <td>Velcade¬Æ PI 2024</td>
                                </tr>
                                <tr>
                                    <td>Daratumumab dose</td>
                                    <td>16 mg/kg IV (loading)</td>
                                    <td>Darzalex¬Æ PI 2024</td>
                                </tr>
                                <tr>
                                    <td>Tumor growth rate</td>
                                    <td>0.015 ‚Äì 0.03 day‚Åª¬π</td>
                                    <td>Rajkumar et al., Blood 2022</td>
                                </tr>
                                <tr>
                                    <td>Healthy growth rate</td>
                                    <td>0.01 ‚Äì 0.02 day‚Åª¬π</td>
                                    <td>Bone marrow recovery studies</td>
                                </tr>
                                <tr>
                                    <td>Interaction strength</td>
                                    <td>0.0 ‚Äì 0.15 (dimensionless)</td>
                                    <td>Model calibration (internal)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

{{ drug_profiles|json_script:"dose-ranges-json" }}
{{ preset_descriptions|json_script:"preset-descriptions-json" }}

<script>
(function () {
    const warningLimits = {
        lenalidomide_dose: 40,
        bortezomib_dose: 1.5,
        daratumumab_dose: 16,
        interaction_strength: 0.2,
    };
    const doseRangesEl = document.getElementById('dose-ranges-json');
    const doseRanges = doseRangesEl ? JSON.parse(doseRangesEl.textContent) : {};
    const presetDescEl = document.getElementById('preset-descriptions-json');
    const presetDescriptions = presetDescEl ? JSON.parse(presetDescEl.textContent) : {};
    const presetCard = document.getElementById('preset-explainer');
    const presetInput = document.getElementById('id_preset');

    const DOSE_FIELD_MAP = {
        lenalidomide_dose: 'lenalidomide',
        bortezomib_dose: 'bortezomib',
        daratumumab_dose: 'daratumumab',
    };
    const DOSE_HELP_SLUG = {
        lenalidomide_dose: 'dose_ranges_lenalidomide',
        bortezomib_dose: 'dose_ranges_bortezomib',
        daratumumab_dose: 'dose_ranges_daratumumab',
    };
    const STATUS_CLASSES = {
        safe: 'badge bg-success',
        warn: 'badge bg-warning text-dark',
        danger: 'badge bg-danger',
    };
    const DOSE_BADGE_COPY = {
        safe: {
            en: 'Within preset guardrail.',
            it: 'Entro il guardrail del preset.',
        },
        warn: {
            en: 'Near the limit ‚Äî monitor closely. {help}',
            it: 'Vicino al limite ‚Äî monitora attentamente. {help}',
        },
        danger: {
            en: 'Outside guardrail ‚Äî adjust dose. {help}',
            it: 'Fuori guardrail ‚Äî rivedi la dose. {help}',
        },
        unknown: {
            en: '',
            it: '',
        },
    };
    const INTERACTION_COPY = {
        safe: {
            en: 'Coupling within safe band.',
            it: 'Accoppiamento entro la banda sicura.',
        },
        warn: {
            en: 'Borderline synergy ‚Äî watch toxicity. {help}',
            it: 'Sinergia borderline ‚Äî osserva la tossicit√†. {help}',
        },
        danger: {
            en: 'High synergy/toxicity ‚Äî reduce doses. {help}',
            it: 'Sinergia/tossicit√† alta ‚Äî riduci le dosi. {help}',
        },
        unknown: {
            en: '',
            it: '',
        },
    };

    const setContextBadge = (inputId, status, html) => {
        const badgeEl = document.getElementById(`badge-${inputId}`);
        if (!badgeEl) {
            return;
        }
        if (!html) {
            badgeEl.textContent = '';
            badgeEl.className = 'context-badge small mt-1 d-none';
            return;
        }
        badgeEl.className = `context-badge small mt-1 ${STATUS_CLASSES[status] || 'badge bg-secondary'}`;
        badgeEl.innerHTML = html;
    };

    const formatCopy = (copySet, lang, slug) => {
        if (!copySet) {
            return '';
        }
        const tpl = copySet[lang] || copySet.en || '';
        return tpl.replace('{help}', `<a data-help="${slug}">${lang === 'it' ? 'Guida' : 'Help'}</a>`);
    };

    const updateDoseContext = (fieldName) => {
        const fieldKey = DOSE_FIELD_MAP[fieldName];
        const input = document.getElementById(`id_${fieldName}`);
        if (!fieldKey || !input) {
            return;
        }
        const profile = doseRanges[fieldKey] || {};
        const range = profile.dose_range || {};
        const min = parseFloat(range.min);
        const max = parseFloat(range.max);
        const value = parseFloat(input.value);
        const status = (window.BadgeUtils && window.BadgeUtils.computeDoseStatus(value, min, max)) || 'unknown';
        const lang = getCurrentLang ? getCurrentLang() : 'en';
        const html = formatCopy(DOSE_BADGE_COPY[status], lang, DOSE_HELP_SLUG[fieldName]);
        setContextBadge(input.id, status, html);

        // üé® Apply visual zone coloring
        applyDoseZoneColor(input, value, min, max, profile);
    };

    /**
     * Apply visual color zones to dose inputs based on value relative to preset range
     * @param {HTMLElement} input - The input element
     * @param {number} value - Current input value
     * @param {number} min - Minimum safe dose from preset
     * @param {number} max - Maximum safe dose from preset
     * @param {object} profile - Drug profile with optimal_dose
     */
    const applyDoseZoneColor = (input, value, min, max, profile) => {
        if (!Number.isFinite(value) || !Number.isFinite(min) || !Number.isFinite(max)) {
            input.classList.remove('zone-safe', 'zone-caution', 'zone-danger', 'zone-optimal', 'dose-input');
            return;
        }

        input.classList.add('dose-input');
        input.classList.remove('zone-safe', 'zone-caution', 'zone-danger', 'zone-optimal');

        // Check if value is optimal dose (within 5% tolerance)
        const optimalDose = parseFloat(profile.optimal_dose);
        if (Number.isFinite(optimalDose) && Math.abs(value - optimalDose) / optimalDose < 0.05) {
            input.classList.add('zone-optimal');
            return;
        }

        const rangeSize = max - min;
        const safeThreshold = min + rangeSize * 0.80;  // 0-80% of range = safe (green)
        const cautionThreshold = min + rangeSize * 0.95; // 80-95% = caution (yellow)

        if (value < min || value > max) {
            input.classList.add('zone-danger');  // Outside preset range = danger (red)
        } else if (value <= safeThreshold) {
            input.classList.add('zone-safe');    // 0-80% = safe (green)
        } else if (value <= cautionThreshold) {
            input.classList.add('zone-caution'); // 80-95% = caution (yellow)
        } else {
            input.classList.add('zone-danger');  // 95-100% = danger (red)
        }
    };

    const updateAllDoseContexts = () => {
        Object.keys(DOSE_FIELD_MAP).forEach(updateDoseContext);
    };

    const interactionField = document.getElementById('{{ form.interaction_strength.id_for_label }}');
    const interactionBadge = document.getElementById('interaction-strength-badge');

    const updateInteractionContext = () => {
        if (!interactionField) {
            return;
        }
        const value = parseFloat(interactionField.value);
        const lang = getCurrentLang ? getCurrentLang() : 'en';
        const status = (window.BadgeUtils && window.BadgeUtils.computeInteractionStatus(value)) || 'unknown';
        const html = formatCopy(INTERACTION_COPY[status], lang, 'interaction_strength');
        setContextBadge(interactionField.id, status, html);
        if (interactionBadge) {
            const textMap = {
                safe: { en: 'Safe', it: 'Sicuro' },
                warn: { en: 'Borderline', it: 'Attenzione' },
                danger: { en: 'Unsafe', it: 'Rischioso' },
            };
            interactionBadge.className = `badge ${STATUS_CLASSES[status] || 'bg-secondary'}`;
            interactionBadge.textContent = (textMap[status] || textMap.safe)[lang];
        }
    };

    const applyWarnings = (input) => {
        const limit = warningLimits[input.name];
        if (limit === undefined) {
            input.classList.remove('is-warning');
            return;
        }
        const value = parseFloat(input.value);
        if (Number.isFinite(value) && value > limit) {
            input.classList.add('is-warning');
        } else {
            input.classList.remove('is-warning');
        }
    };

    document.querySelectorAll('#simulation-parameters-form .form-control').forEach((input) => {
        applyWarnings(input);
        input.addEventListener('input', () => {
            applyWarnings(input);
            if (input === interactionField) {
                updateInteractionContext();
            }
        });
        input.addEventListener('blur', () => applyWarnings(input));
    });

    if (interactionField) {
        updateInteractionContext();
    }
    updateAllDoseContexts();

    const formEl = document.getElementById('simulation-parameters-form');
    if (formEl) {
        formEl.addEventListener('reset', () => {
            setTimeout(() => {
                document.querySelectorAll('#simulation-parameters-form .form-control').forEach(applyWarnings);
                updateInteractionContext();
                updateAllDoseContexts();
                renderPresetCard(getCurrentLang ? getCurrentLang() : 'en');
            }, 0);
        });
    }

    const renderPresetCard = (lang) => {
        if (!presetCard || !presetInput) {
            return;
        }
        const desc = presetDescriptions[presetInput.value];
        if (!desc) {
            presetCard.classList.add('d-none');
            return;
        }
        
        // Get story data for current language
        const story = desc[`story_${lang}`] || desc.story_en || {};
        
        // If no story available, fallback to simple description
        if (!story.title) {
            const enNode = presetCard.querySelector('.t-en');
            const itNode = presetCard.querySelector('.t-it');
            if (enNode) enNode.textContent = desc.en || '';
            if (itNode) itNode.textContent = desc.it || '';
            presetCard.classList.remove('d-none');
            return;
        }
        
        // Render full storyline
        const titleEl = presetCard.querySelector('.story-title');
        if (titleEl) titleEl.textContent = story.title || '';
        
        const bgEl = presetCard.querySelector('.story-background');
        if (bgEl) bgEl.textContent = story.background || '';
        
        const challengeEl = presetCard.querySelector('.story-challenge');
        if (challengeEl) challengeEl.textContent = story.challenge || '';
        
        const whyTextEl = presetCard.querySelector('.story-why-text');
        if (whyTextEl) whyTextEl.textContent = story.why_these_drugs || '';
        
        const outcomeTextEl = presetCard.querySelector('.story-outcome-text');
        if (outcomeTextEl) outcomeTextEl.textContent = story.expected_outcome || '';
        
        const learningListEl = presetCard.querySelector('.story-learning-list');
        if (learningListEl && Array.isArray(story.learning_points)) {
            learningListEl.innerHTML = '';
            story.learning_points.forEach(point => {
                const li = document.createElement('li');
                li.textContent = point;
                learningListEl.appendChild(li);
            });
        }
        
        presetCard.classList.remove('d-none');
    };

    if (presetInput) {
        presetInput.addEventListener('change', () => {
            renderPresetCard(getCurrentLang ? getCurrentLang() : 'en');
        });
        renderPresetCard(getCurrentLang ? getCurrentLang() : 'en');
    }

    document.addEventListener('language-changed', (event) => {
        renderPresetCard(event.detail.lang);
        updateAllDoseContexts();
        updateInteractionContext();
    });

    document.body.addEventListener('htmx:afterRequest', (event) => {
        if (!event.detail || !event.detail.target) {
            return;
        }
        if (event.detail.target.id === 'simulation-results') {
            const badgeEl = document.getElementById('last-run');
            if (badgeEl) {
                const lang = getCurrentLang ? getCurrentLang() : 'en';
                const label = lang === 'it' ? 'Ultima esecuzione: ' : 'Last run: ';
                badgeEl.textContent = `${label}${new Date().toLocaleTimeString()}`;
            }
            event.detail.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
})();
</script>
