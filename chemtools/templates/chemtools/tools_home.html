{% extends "base.html" %}

{% block content %}
<!-- Main Explanation Banner -->
<div class="alert alert-primary border-primary mb-4">
    <div class="d-flex align-items-start gap-3">
        <div style="font-size: 3rem;">üíä</div>
        <div class="flex-grow-1">
            <h1 class="h3 alert-heading mb-2">
                <span class="t-en">Drug Discovery & Cheminformatics Tools</span>
                <span class="t-it">Strumenti Ricerca Farmaci & Cheminformatica</span>
            </h1>
            <div class="t-en">
                <p class="mb-2"><strong>What is this page?</strong> This is your hub for analyzing chemical compounds and searching for new drug candidates.</p>
                <p class="mb-2"><strong>Available Tools:</strong></p>
                <ul class="mb-2">
                    <li><strong>üíä Drug Parameters:</strong> Calculate molecular properties (weight, LogP, drug-likeness)</li>
                    <li><strong>üî¨ Binding Visualizer:</strong> View 3D structures and protein-ligand interactions</li>
                    <li><strong>üîç Similarity Search:</strong> Find molecules similar to known drugs (e.g., like Bortezomib/Velcade)</li>
                </ul>
                <p class="mb-0"><strong>üí° How it works:</strong> Submit a job using the buttons above ‚Üí System processes it ‚Üí Results appear in the table below</p>
            </div>
            <div class="t-it">
                <p class="mb-2"><strong>Cos'√® questa pagina?</strong> Questo √® il tuo hub per analizzare composti chimici e cercare nuovi candidati farmaci.</p>
                <p class="mb-2"><strong>Strumenti Disponibili:</strong></p>
                <ul class="mb-2">
                    <li><strong>üíä Parametri Farmaci:</strong> Calcola propriet√† molecolari (peso, LogP, drug-likeness)</li>
                    <li><strong>üî¨ Visualizzatore Binding:</strong> Vedi strutture 3D e interazioni proteina-ligando</li>
                    <li><strong>üîç Ricerca Similarit√†:</strong> Trova molecole simili a farmaci noti (es. come Bortezomib/Velcade)</li>
                </ul>
                <p class="mb-0"><strong>üí° Come funziona:</strong> Invia un job usando i bottoni sopra ‚Üí Il sistema lo processa ‚Üí I risultati appaiono nella tabella sotto</p>
            </div>
        </div>
    </div>
</div>

<!-- Tool Buttons with Descriptions -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card h-100 border-primary hover-card">
            <div class="card-body">
                <h3 class="h5">
                    üíä <span class="t-en">Drug Parameters</span>
                    <span class="t-it">Parametri Farmaci</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">Calculate molecular properties like weight, LogP, number of H-bond donors/acceptors</span>
                    <span class="t-it">Calcola propriet√† molecolari come peso, LogP, numero donatori/accettori legami H</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use when:</strong><strong class="t-it">Usa quando:</strong>
                    <span class="t-en">You have a molecule's SMILES and want to check if it follows drug-likeness rules</span>
                    <span class="t-it">Hai lo SMILES di una molecola e vuoi verificare se segue regole drug-likeness</span>
                </p>
                <a class="btn btn-primary w-100" href="{% url 'chemtools:drug_params' %}">
                    <span class="t-en">Open Tool</span>
                    <span class="t-it">Apri Strumento</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 border-success hover-card">
            <div class="card-body">
                <h3 class="h5">
                    üî¨ <span class="t-en">Binding Visualizer</span>
                    <span class="t-it">Visualizzatore Binding</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">View 3D protein-ligand structures and analyze binding interactions</span>
                    <span class="t-it">Visualizza strutture 3D proteina-ligando e analizza interazioni binding</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use when:</strong><strong class="t-it">Usa quando:</strong>
                    <span class="t-en">You have a PDB file and want to see how a drug binds to its target protein</span>
                    <span class="t-it">Hai un file PDB e vuoi vedere come un farmaco si lega alla proteina target</span>
                </p>
                <a class="btn btn-success w-100" href="{% url 'chemtools:binding_viz' %}">
                    <span class="t-en">Open Tool</span>
                    <span class="t-it">Apri Strumento</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 border-info hover-card">
            <div class="card-body">
                <h3 class="h5">
                    üîç <span class="t-en">Similarity Search</span>
                    <span class="t-it">Ricerca Similarit√†</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">Find molecules similar to known drugs (e.g., Bortezomib, Lenalidomide)</span>
                    <span class="t-it">Trova molecole simili a farmaci noti (es. Bortezomib, Lenalidomide)</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use when:</strong><strong class="t-it">Usa quando:</strong>
                    <span class="t-en">You want to discover new drug candidates with similar structure to effective treatments</span>
                    <span class="t-it">Vuoi scoprire nuovi candidati farmaci con struttura simile a trattamenti efficaci</span>
                </p>
                <a class="btn btn-info w-100" href="{% url 'chemtools:similarity' %}">
                    <span class="t-en">Open Tool</span>
                    <span class="t-it">Apri Strumento</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
    <div>
        <h2 class="h4 mb-0">
            <span class="t-en">üìä Your Analysis Jobs</span>
            <span class="t-it">üìä I Tuoi Job di Analisi</span>
        </h2>
        <small class="text-muted">
            <span class="t-en">Track queued and completed analyses</span>
            <span class="t-it">Traccia analisi in coda e completate</span>
        </small>
    </div>
</div>

<div class="alert alert-info border-info mb-4" role="alert">
    <div class="d-flex align-items-start gap-2">
        <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
        <div>
            <strong class="t-en">How to Read This Table:</strong>
            <strong class="t-it">Come Leggere Questa Tabella:</strong>
            <ul class="small mb-0 mt-2">
                <li class="t-en"><strong>Status badges:</strong> üü¢ Success (green) = Job completed, üü° Queued (yellow) = Processing, üî¥ Failed (red) = Error occurred</li>
                <li class="t-en"><strong>Outputs:</strong> Click "View HTML" for interactive results or "Download CSV" for data</li>
                <li class="t-en"><strong>Thumbnail:</strong> Preview of molecular structure (if available)</li>
                <li class="t-en"><strong>View log:</strong> See technical details and any error messages</li>
                <li class="t-it"><strong>Badge Status:</strong> üü¢ Success (verde) = Job completato, üü° Queued (giallo) = In elaborazione, üî¥ Failed (rosso) = Errore</li>
                <li class="t-it"><strong>Outputs:</strong> Clicca "View HTML" per risultati interattivi o "Download CSV" per dati</li>
                <li class="t-it"><strong>Thumbnail:</strong> Anteprima struttura molecolare (se disponibile)</li>
                <li class="t-it"><strong>View log:</strong> Vedi dettagli tecnici e messaggi errore</li>
            </ul>
        </div>
    </div>
</div>

<div class="alert alert-warning border-warning" role="alert">
    <strong>‚ö†Ô∏è <span class="t-en">Clinical Decision Support Notice:</span><span class="t-it">Avviso Supporto Decisioni Cliniche:</span></strong>
    <span class="t-en">Results are provided for research and educational purposes only and must be reviewed alongside institutional guidelines before any clinical use.</span>
    <span class="t-it">I risultati sono forniti solo per scopi di ricerca ed educativi e devono essere revisionati secondo linee guida istituzionali prima di qualsiasi uso clinico.</span>
</div>

{% if jobs %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">
                                <span class="t-en">Created</span>
                                <span class="t-it">Creato</span>
                            </th>
                            <th scope="col">
                                <span class="t-en">Type</span>
                                <span class="t-it">Tipo</span>
                            </th>
                            <th scope="col">Status</th>
                            <th scope="col">
                                <span class="t-en">Requested By</span>
                                <span class="t-it">Richiesto Da</span>
                            </th>
                            <th scope="col">
                                <span class="t-en">Inputs</span>
                                <span class="t-it">Input</span>
                            </th>
                            <th scope="col">
                                <span class="t-en">Outputs</span>
                                <span class="t-it">Output</span>
                            </th>
                            <th scope="col">Thumbnail</th>
                            <th scope="col" class="text-end">
                                <span class="t-en">Actions</span>
                                <span class="t-it">Azioni</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                            {% with status=job.status_label %}
                            <tr data-job-id="{{ job.pk }}" data-job-status="{{ status.0 }}"{% if status.0 == "Queued" %} hx-get="{% url 'chemtools:job_status' job.pk %}" hx-trigger="load, every 5s" hx-target="this" hx-swap="none"{% endif %}>
                                <td>{{ job.created|date:"Y-m-d H:i" }}</td>
                                <td>{{ job.get_kind_display }}</td>
                                <td data-cell="status">
                                    {% if status.0 == "Queued" %}
                                        <div class="mb-1">
                                            <span class="badge bg-{{ status.1 }}">
                                                {{ status.0 }}
                                                <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
                                            </span>
                                        </div>
                                        <div class="progress" style="height: 8px; min-width: 120px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" 
                                                 style="width: {{ job.progress_percent }}%"
                                                 aria-valuenow="{{ job.progress_percent }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"
                                                 data-progress="{{ job.progress_percent }}">
                                            </div>
                                        </div>
                                        <small class="text-muted" data-progress-message>{{ job.progress_message|default:"Processing..." }}</small>
                                    {% else %}
                                        <span class="badge bg-{{ status.1 }}">{{ status.0 }}</span>
                                    {% endif %}
                                </td>
                                <td>{% if job.user %}{{ job.user.username }}{% else %}‚Äì{% endif %}</td>
                                <td>
                                    <div class="small text-muted">{{ job.input_a|default:"‚Äì" }}</div>
                                    {% if job.input_b %}<div class="small text-muted">{{ job.input_b }}</div>{% endif %}
                                </td>
                                <td data-cell="outputs">
                                    {% if job.out_html or job.out_csv %}
                                        <a href="{% url 'chemtools:job_detail' job.pk %}" class="btn btn-primary btn-sm">
                                            <span class="t-en">üìä View Results</span>
                                            <span class="t-it">üìä Vedi Risultati</span>
                                        </a>
                                    {% else %}
                                        <span class="text-muted small">
                                            <span class="t-en">No output yet</span>
                                            <span class="t-it">Nessun output</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td data-cell="thumbnail">
                                    {% if job.thumbnail_url %}
                                        <img src="{{ job.thumbnail_url }}" alt="thumbnail" class="img-thumbnail img-fluid" style="max-width: 96px;">
                                    {% else %}
                                        <span class="text-muted small">No preview</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#logModal{{ job.pk }}">
                                            View log
                                        </button>
                                        <a class="btn btn-outline-primary" href="{% url 'chemtools:job_retry' job.pk %}">Retry</a>
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% for job in jobs %}
        <div class="modal fade" id="logModal{{ job.pk }}" tabindex="-1" aria-labelledby="logModalLabel{{ job.pk }}" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logModalLabel{{ job.pk }}">Job Log ‚Äì {{ job.get_kind_display }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <pre class="small mb-0">{{ job.log|default:"(no log)" }}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary" role="alert">
        <div class="text-center py-4">
            <div style="font-size: 3rem;" class="mb-3">üì≠</div>
            <h3 class="h5">
                <span class="t-en">No Jobs Yet</span>
                <span class="t-it">Nessun Job Ancora</span>
            </h3>
            <p class="text-muted mb-3">
                <span class="t-en">You haven't submitted any analysis jobs yet. Get started by choosing a tool above!</span>
                <span class="t-it">Non hai ancora inviato job di analisi. Inizia scegliendo uno strumento sopra!</span>
            </p>
            <div class="d-flex gap-2 justify-content-center">
                <a href="{% url 'chemtools:drug_params' %}" class="btn btn-primary">
                    <span class="t-en">Try Drug Parameters</span>
                    <span class="t-it">Prova Parametri Farmaci</span>
                </a>
                <a href="{% url 'chemtools:similarity' %}" class="btn btn-info">
                    <span class="t-en">Try Similarity Search</span>
                    <span class="t-it">Prova Ricerca Similarit√†</span>
                </a>
            </div>
        </div>
    </div>
{% endif %}

<style>
.hover-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.hover-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2) !important;
}
</style>

{% block extra_js %}
{{ block.super }}
<script>
(() => {
    const buildOutputs = (data, jobId) => {
        if (!data.has_html && !data.has_csv) {
            return '<span class="text-muted small"><span class="t-en">No output yet</span><span class="t-it">Nessun output</span></span>';
        }
        return `<a href="/chemtools/job/${jobId}/" class="btn btn-primary btn-sm"><span class="t-en">üìä View Results</span><span class="t-it">üìä Vedi Risultati</span></a>`;
    };

    document.body.addEventListener('htmx:afterRequest', (event) => {
        const detail = event.detail;
        if (!detail || detail.mmMatchedPath !== 'chemtools') {
            return;
        }
        const targetEl = detail.target || event.target;
        const row = targetEl ? targetEl.closest('tr[data-job-id]') : null;
        if (!row) {
            return;
        }
        const data = detail.mmParsedJson;
        if (!data) {
            return;
        }
        
        // Update status badge and progress bar
        const statusCell = row.querySelector('[data-cell="status"]');
        if (statusCell) {
            if (data.status === 'Queued') {
                const progressPercent = data.progress_percent || 0;
                const progressMessage = data.progress_message || 'Processing...';
                statusCell.innerHTML = `
                    <div class="mb-1">
                        <span class="badge bg-${data.variant}">
                            ${data.status}
                            <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
                        </span>
                    </div>
                    <div class="progress" style="height: 8px; min-width: 120px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: ${progressPercent}%"
                             aria-valuenow="${progressPercent}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             data-progress="${progressPercent}">
                        </div>
                    </div>
                    <small class="text-muted" data-progress-message>${progressMessage}</small>
                `;
            } else {
                statusCell.innerHTML = `<span class="badge bg-${data.variant}">${data.status}</span>`;
            }
        }
        
        const outputsCell = row.querySelector('[data-cell="outputs"]');
        if (outputsCell) {
            const jobId = row.dataset.jobId;
            outputsCell.innerHTML = buildOutputs(data, jobId);
        }
        const thumbCell = row.querySelector('[data-cell="thumbnail"]');
        if (thumbCell) {
            thumbCell.innerHTML = data.thumbnail_url
                ? `<img src="${data.thumbnail_url}" alt="thumbnail" class="img-thumbnail" style="max-width: 96px;">`
                : '<span class="text-muted small">No preview</span>';
        }
        row.dataset.jobStatus = data.status;
        if (data.status !== 'Queued') {
            row.removeAttribute('hx-trigger');
        }
    });
})();
</script>
{% endblock %}
{% endblock %}
