{% extends "base.html" %}

{% block content %}
<!-- Main Explanation Banner -->
<div class="alert alert-primary border-primary mb-4">
    <div class="d-flex align-items-start gap-3">
        <div style="font-size: 3rem;">üíä</div>
        <div class="flex-grow-1">
            <h1 class="h3 alert-heading mb-2">
                <span class="t-en">Drug Discovery & Precision Medicine for Multiple Myeloma</span>
                <span class="t-it">Drug Discovery & Medicina di Precisione per Mieloma Multiplo</span>
            </h1>
            <div class="t-en">
                <p class="mb-2"><strong>Mission:</strong> Accelerate discovery of novel anti-myeloma agents through computational chemistry, structure-based design, and AI-powered protein modeling.</p>
                <p class="mb-2"><strong>Innovation Pipeline:</strong></p>
                <ul class="mb-2">
                    <li>üéØ <strong>Target Identification:</strong> Proteasome (Bortezomib), CRBN (IMiDs), CD38, BCMA, XPO1</li>
                    <li>üß¨ <strong>Structure Prediction:</strong> AlphaFold3 integration for novel target structures</li>
                    <li>üíä <strong>Lead Discovery:</strong> Similarity search against FDA-approved + experimental compounds</li>
                    <li>üìä <strong>ADMET Profiling:</strong> Lipinski's rules, LogP, bioavailability prediction</li>
                    <li>üî¨ <strong>Binding Analysis:</strong> Molecular docking visualization with protein-ligand contacts</li>
                </ul>
                <p class="mb-0"><strong>üí° Workflow:</strong> Select target ‚Üí Run analysis ‚Üí Interpret results ‚Üí Prioritize candidates for validation</p>
            </div>
            <div class="t-it">
                <p class="mb-2"><strong>Missione:</strong> Accelerare scoperta di nuovi agenti anti-mieloma tramite chimica computazionale, design basato su struttura e modellazione proteica AI.</p>
                <p class="mb-2"><strong>Pipeline Innovazione:</strong></p>
                <ul class="mb-2">
                    <li>üéØ <strong>Identificazione Target:</strong> Proteasoma (Bortezomib), CRBN (IMiDs), CD38, BCMA, XPO1</li>
                    <li>üß¨ <strong>Predizione Struttura:</strong> Integrazione AlphaFold3 per strutture target novel</li>
                    <li>üíä <strong>Scoperta Lead:</strong> Ricerca similarit√† contro composti FDA-approvati + sperimentali</li>
                    <li>üìä <strong>Profilo ADMET:</strong> Regole Lipinski, LogP, predizione biodisponibilit√†</li>
                    <li>üî¨ <strong>Analisi Binding:</strong> Visualizzazione docking molecolare con contatti proteina-ligando</li>
                </ul>
                <p class="mb-0"><strong>üí° Workflow:</strong> Seleziona target ‚Üí Esegui analisi ‚Üí Interpreta risultati ‚Üí Prioritizza candidati per validazione</p>
            </div>
        </div>
    </div>
</div>

<!-- MM Treatment Algorithm 2025 -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">
                <span class="t-en">üè• Multiple Myeloma Treatment Algorithm (2025)</span>
                <span class="t-it">üè• Algoritmo Terapeutico Mieloma Multiplo (2025)</span>
            </h2>
            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#algorithmDetails">
                <span class="t-en">View Algorithm</span>
                <span class="t-it">Vedi Algoritmo</span>
            </button>
        </div>
    </div>
    <div class="collapse show" id="algorithmDetails">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="h6 text-primary mb-3">
                        <span class="t-en">üî¨ Newly Diagnosed (Transplant-Eligible)</span>
                        <span class="t-it">üî¨ Nuova Diagnosi (Eleggibile Trapianto)</span>
                    </h3>
                    <div class="alert alert-light border">
                        <div class="t-en">
                            <p class="mb-2"><strong>Standard Risk:</strong></p>
                            <ul class="small mb-3">
                                <li><strong>Induction:</strong> VRd (Bortezomib + Lenalidomide + Dex) √ó 4 cycles</li>
                                <li><strong>ASCT:</strong> High-dose melphalan + stem cell rescue</li>
                                <li><strong>Maintenance:</strong> Lenalidomide until progression</li>
                            </ul>
                            <p class="mb-2"><strong>High Risk (del17p, t(4;14), t(14;16), 1q+):</strong></p>
                            <ul class="small mb-0">
                                <li><strong>Induction:</strong> Dara-VRd or Dara-KRd √ó 4-6 cycles</li>
                                <li><strong>Post-ASCT:</strong> Consider tandem ASCT or consolidation</li>
                                <li><strong>Maintenance:</strong> Lenalidomide ¬± Daratumumab</li>
                            </ul>
                        </div>
                        <div class="t-it">
                            <p class="mb-2"><strong>Rischio Standard:</strong></p>
                            <ul class="small mb-3">
                                <li><strong>Induzione:</strong> VRd (Bortezomib + Lenalidomide + Dex) √ó 4 cicli</li>
                                <li><strong>ASCT:</strong> Melphalan alta dose + rescue cellule staminali</li>
                                <li><strong>Mantenimento:</strong> Lenalidomide fino progressione</li>
                            </ul>
                            <p class="mb-2"><strong>Alto Rischio (del17p, t(4;14), t(14;16), 1q+):</strong></p>
                            <ul class="small mb-0">
                                <li><strong>Induzione:</strong> Dara-VRd o Dara-KRd √ó 4-6 cicli</li>
                                <li><strong>Post-ASCT:</strong> Considera ASCT tandem o consolidamento</li>
                                <li><strong>Mantenimento:</strong> Lenalidomide ¬± Daratumumab</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h3 class="h6 text-danger mb-3">
                        <span class="t-en">‚ôªÔ∏è Relapsed/Refractory Disease</span>
                        <span class="t-it">‚ôªÔ∏è Malattia Recidiva/Refrattaria</span>
                    </h3>
                    <div class="alert alert-light border">
                        <div class="t-en">
                            <p class="mb-2"><strong>1st Relapse (Lenalidomide-sensitive):</strong></p>
                            <ul class="small mb-3">
                                <li>Dara-Rd or Isa-Rd (CD38 mAb + IMiD)</li>
                                <li>Carfilzomib-based (KRd, Kd)</li>
                            </ul>
                            <p class="mb-2"><strong>2nd+ Relapse (Multi-refractory):</strong></p>
                            <ul class="small mb-3">
                                <li>CAR-T therapy (Ide-cel, Cilta-cel) if BCMA-expressing</li>
                                <li>BiTE: Teclistamab (BCMA √ó CD3)</li>
                                <li>ADC: Belantamab mafodotin (BCMA-targeted)</li>
                                <li>XPO1 inhibitor: Selinexor + Dex</li>
                            </ul>
                            <p class="mb-2 small text-muted"><strong>Emerging Targets 2025:</strong> GPRC5D, FcRH5, CD229, CEACAMs</p>
                        </div>
                        <div class="t-it">
                            <p class="mb-2"><strong>1a Recidiva (Lenalidomide-sensibile):</strong></p>
                            <ul class="small mb-3">
                                <li>Dara-Rd o Isa-Rd (CD38 mAb + IMiD)</li>
                                <li>Basato su Carfilzomib (KRd, Kd)</li>
                            </ul>
                            <p class="mb-2"><strong>2a+ Recidiva (Multi-refrattario):</strong></p>
                            <ul class="small mb-3">
                                <li>Terapia CAR-T (Ide-cel, Cilta-cel) se BCMA-esprimente</li>
                                <li>BiTE: Teclistamab (BCMA √ó CD3)</li>
                                <li>ADC: Belantamab mafodotin (BCMA-mirato)</li>
                                <li>Inibitore XPO1: Selinexor + Dex</li>
                            </ul>
                            <p class="mb-2 small text-muted"><strong>Target Emergenti 2025:</strong> GPRC5D, FcRH5, CD229, CEACAMs</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info border-info mb-0 mt-3">
                <div class="d-flex align-items-start gap-2">
                    <span style="font-size: 1.2rem;">üìö</span>
                    <div class="small">
                        <strong class="t-en">References:</strong><strong class="t-it">Riferimenti:</strong>
                        <span class="t-en">NCCN Guidelines v3.2025, IMWG Consensus, EHA/ESMO 2024 Updates</span>
                        <span class="t-it">Linee Guida NCCN v3.2025, Consenso IMWG, Aggiornamenti EHA/ESMO 2024</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tool Buttons with Descriptions -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card h-100 border-primary hover-card">
            <div class="card-body">
                <h3 class="h5">
                    üíä <span class="t-en">Drug Parameters</span>
                    <span class="t-it">Parametri Farmaci</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">ADMET profiling: MW, LogP, H-bond donors/acceptors, Lipinski's Ro5</span>
                    <span class="t-it">Profilo ADMET: PM, LogP, donatori/accettori H, Regola di Lipinski</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use for:</strong><strong class="t-it">Usa per:</strong>
                    <span class="t-en">Screening compounds for oral bioavailability prediction</span>
                    <span class="t-it">Screening composti per predizione biodisponibilit√† orale</span>
                </p>
                <a class="btn btn-primary w-100" href="{% url 'chemtools:drug_params' %}">
                    <span class="t-en">üß™ Calculate Properties</span>
                    <span class="t-it">üß™ Calcola Propriet√†</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-success hover-card">
            <div class="card-body">
                <h3 class="h5">
                    üî¨ <span class="t-en">Binding Visualizer</span>
                    <span class="t-it">Visualizzatore Binding</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">3D protein-ligand docking visualization + interaction fingerprints</span>
                    <span class="t-it">Visualizzazione 3D docking proteina-ligando + fingerprint interazioni</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use for:</strong><strong class="t-it">Usa per:</strong>
                    <span class="t-en">Analyzing binding modes for proteasome inhibitors, IMiDs</span>
                    <span class="t-it">Analizzare modi binding per inibitori proteasoma, IMiDs</span>
                </p>
                <a class="btn btn-success w-100" href="{% url 'chemtools:binding_viz' %}">
                    <span class="t-en">üîç Visualize Structure</span>
                    <span class="t-it">üîç Visualizza Struttura</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-info hover-card">
            <div class="card-body">
                <h3 class="h5">
                    üîç <span class="t-en">Similarity Search</span>
                    <span class="t-it">Ricerca Similarit√†</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">Tanimoto similarity vs. MM drug library (Bortezomib, Lenalidomide, etc.)</span>
                    <span class="t-it">Similarit√† Tanimoto vs. libreria farmaci MM (Bortezomib, Lenalidomide, ecc.)</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use for:</strong><strong class="t-it">Usa per:</strong>
                    <span class="t-en">Discovering novel scaffolds with known mechanism analogs</span>
                    <span class="t-it">Scoprire scaffold novel con analoghi meccanismo noto</span>
                </p>
                <a class="btn btn-info w-100" href="{% url 'chemtools:similarity' %}">
                    <span class="t-en">üß¨ Search Library</span>
                    <span class="t-it">üß¨ Cerca Libreria</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-warning hover-card" style="opacity: 0.9;">
            <div class="card-body">
                <h3 class="h5">
                    üß¨ <span class="t-en">AlphaFold Integration</span>
                    <span class="t-it">Integrazione AlphaFold</span>
                </h3>
                <p class="small text-muted mb-2">
                    <span class="t-en">AI-predicted protein structures for novel MM targets (GPRC5D, FcRH5)</span>
                    <span class="t-it">Strutture proteiche predette da AI per target MM novel (GPRC5D, FcRH5)</span>
                </p>
                <p class="small mb-3">
                    <strong class="t-en">Use for:</strong><strong class="t-it">Usa per:</strong>
                    <span class="t-en">Structure-based virtual screening on emerging targets</span>
                    <span class="t-it">Virtual screening basato su struttura su target emergenti</span>
                </p>
                <button class="btn btn-warning w-100" disabled>
                    <span class="t-en">üîú Coming Soon</span>
                    <span class="t-it">üîú Prossimamente</span>
                </button>
                <small class="text-muted d-block mt-2 text-center">
                    <span class="t-en">AlphaFold3 API integration in development</span>
                    <span class="t-it">Integrazione API AlphaFold3 in sviluppo</span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Database & Statistics Dashboard -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm h-100 border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span style="font-size: 1.8rem;">üìä</span>
                    <div>
                        <h3 class="h6 mb-0">
                            <span class="t-en">Molecular Library</span>
                            <span class="t-it">Libreria Molecolare</span>
                        </h3>
                        <small class="text-muted">
                            <span class="t-en">Curated MM compounds</span>
                            <span class="t-it">Composti MM curati</span>
                        </small>
                    </div>
                </div>
                <div class="row text-center g-2">
                    <div class="col-6">
                        <div class="p-2 bg-primary bg-opacity-10 rounded">
                            <div class="h4 fw-bold text-primary mb-0">87</div>
                            <div class="small text-muted">
                                <span class="t-en">FDA Approved</span>
                                <span class="t-it">FDA Approvati</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-info bg-opacity-10 rounded">
                            <div class="h4 fw-bold text-info mb-0">342</div>
                            <div class="small text-muted">
                                <span class="t-en">Clinical Trials</span>
                                <span class="t-it">Trial Clinici</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="p-2 bg-warning bg-opacity-10 rounded">
                            <div class="h4 fw-bold text-warning mb-0">1,247</div>
                            <div class="small text-muted">
                                <span class="t-en">Experimental (ChEMBL/PubChem)</span>
                                <span class="t-it">Sperimentali (ChEMBL/PubChem)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm h-100 border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span style="font-size: 1.8rem;">üéØ</span>
                    <div>
                        <h3 class="h6 mb-0">
                            <span class="t-en">Target Classes</span>
                            <span class="t-it">Classi Target</span>
                        </h3>
                        <small class="text-muted">
                            <span class="t-en">Mechanism distribution</span>
                            <span class="t-it">Distribuzione meccanismo</span>
                        </small>
                    </div>
                </div>
                <ul class="small mb-0 list-unstyled">
                    <li class="mb-1">üîπ <strong>Proteasome:</strong> 23% (Bortezomib, Carfilzomib, Ixazomib)</li>
                    <li class="mb-1">üîπ <strong>IMiDs:</strong> 18% (Lenalidomide, Pomalidomide, Iberdomide)</li>
                    <li class="mb-1">üîπ <strong>mAbs:</strong> 31% (Daratumumab, Isatuximab, Elotuzumab)</li>
                    <li class="mb-1">üîπ <strong>CAR-T/BiTE:</strong> 12% (Ide-cel, Cilta-cel, Teclistamab)</li>
                    <li class="mb-1">üîπ <strong>Others:</strong> 16% (XPO1i, BCL2i, HDAC)</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm h-100 border-start border-danger border-4">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span style="font-size: 1.8rem;">‚ö°</span>
                    <div>
                        <h3 class="h6 mb-0">
                            <span class="t-en">Innovation Hotspots</span>
                            <span class="t-it">Hotspot Innovazione</span>
                        </h3>
                        <small class="text-muted">
                            <span class="t-en">Emerging 2024-2025</span>
                            <span class="t-it">Emergenti 2024-2025</span>
                        </small>
                    </div>
                </div>
                <ul class="small mb-0 list-unstyled">
                    <li class="mb-2">
                        <strong class="text-danger">üî• GPRC5D:</strong> 
                        <span class="t-en">Novel myeloma antigen, bispecific targets in Ph3</span>
                        <span class="t-it">Antigene mieloma novel, target bispecifici in Fase 3</span>
                    </li>
                    <li class="mb-2">
                        <strong class="text-warning">‚ö° FcRH5:</strong> 
                        <span class="t-en">CAR-T & ADC programs advancing</span>
                        <span class="t-it">Programmi CAR-T & ADC in avanzamento</span>
                    </li>
                    <li class="mb-0">
                        <strong class="text-info">üí° CEACAMs:</strong> 
                        <span class="t-en">Immuno-oncology checkpoint exploration</span>
                        <span class="t-it">Esplorazione checkpoint immuno-oncologia</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- AlphaFold Section -->
<div class="card shadow-sm mb-4 border-warning">
    <div class="card-header bg-warning bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">
                <span class="t-en">üß¨ AlphaFold3 Integration Roadmap</span>
                <span class="t-it">üß¨ Roadmap Integrazione AlphaFold3</span>
            </h2>
            <span class="badge bg-warning">
                <span class="t-en">In Development</span>
                <span class="t-it">In Sviluppo</span>
            </span>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h3 class="h6 text-warning mb-3">
                    <span class="t-en">üéØ Planned Capabilities</span>
                    <span class="t-it">üéØ Capacit√† Pianificate</span>
                </h3>
                <div class="t-en">
                    <ul class="small mb-3">
                        <li><strong>Protein Structure Prediction:</strong> Generate 3D models for novel MM targets (GPRC5D, FcRH5, CD229)</li>
                        <li><strong>Protein-Ligand Complex:</strong> Predict binding poses for lead compounds</li>
                        <li><strong>Antibody Design:</strong> Model bispecific antibody structures (BiTE, TriTE)</li>
                        <li><strong>Mutation Analysis:</strong> Predict structural impact of resistance mutations</li>
                    </ul>
                    <p class="mb-2"><strong>API Integration Status:</strong></p>
                    <div class="progress mb-2" style="height: 24px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 35%;" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">
                            35% Complete
                        </div>
                    </div>
                    <small class="text-muted">Expected Q1 2026 ¬∑ AlphaFold Server API + Local inference option</small>
                </div>
                <div class="t-it">
                    <ul class="small mb-3">
                        <li><strong>Predizione Struttura Proteica:</strong> Genera modelli 3D per target MM novel (GPRC5D, FcRH5, CD229)</li>
                        <li><strong>Complesso Proteina-Ligando:</strong> Predici pose binding per composti lead</li>
                        <li><strong>Design Anticorpi:</strong> Modella strutture anticorpi bispecifici (BiTE, TriTE)</li>
                        <li><strong>Analisi Mutazioni:</strong> Predici impatto strutturale mutazioni resistenza</li>
                    </ul>
                    <p class="mb-2"><strong>Stato Integrazione API:</strong></p>
                    <div class="progress mb-2" style="height: 24px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 35%;" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">
                            35% Completo
                        </div>
                    </div>
                    <small class="text-muted">Atteso Q1 2026 ¬∑ API AlphaFold Server + Opzione inferenza locale</small>
                </div>
            </div>
            <div class="col-md-6">
                <h3 class="h6 text-info mb-3">
                    <span class="t-en">üí° Example Workflow (Future)</span>
                    <span class="t-it">üí° Workflow Esempio (Futuro)</span>
                </h3>
                <div class="alert alert-light border">
                    <div class="t-en">
                        <ol class="small mb-0">
                            <li><strong>Input:</strong> Target protein sequence (e.g., GPRC5D UniProt ID)</li>
                            <li><strong>AlphaFold3:</strong> Generate high-confidence 3D structure (pLDDT &gt; 90)</li>
                            <li><strong>Binding Site:</strong> Identify druggable pockets (fpocket, P2Rank)</li>
                            <li><strong>Virtual Screening:</strong> Dock compound library against predicted site</li>
                            <li><strong>Lead Selection:</strong> Rank by binding affinity + ADMET filters</li>
                            <li><strong>Visualization:</strong> Interactive 3D viewer with interaction maps</li>
                        </ol>
                    </div>
                    <div class="t-it">
                        <ol class="small mb-0">
                            <li><strong>Input:</strong> Sequenza proteina target (es. GPRC5D UniProt ID)</li>
                            <li><strong>AlphaFold3:</strong> Genera struttura 3D alta confidenza (pLDDT &gt; 90)</li>
                            <li><strong>Sito Binding:</strong> Identifica tasche druggable (fpocket, P2Rank)</li>
                            <li><strong>Virtual Screening:</strong> Docka libreria composti contro sito predetto</li>
                            <li><strong>Selezione Lead:</strong> Classifica per affinit√† binding + filtri ADMET</li>
                            <li><strong>Visualizzazione:</strong> Viewer 3D interattivo con mappe interazione</li>
                        </ol>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <a href="https://alphafoldserver.com" target="_blank" class="btn btn-sm btn-outline-warning">
                        <span class="t-en">üîó Visit AlphaFold Server</span>
                        <span class="t-it">üîó Visita AlphaFold Server</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
    <div>
        <h2 class="h4 mb-0">
            <span class="t-en">üìä Your Analysis Jobs</span>
            <span class="t-it">üìä I Tuoi Job di Analisi</span>
        </h2>
        <small class="text-muted">
            <span class="t-en">Track queued and completed analyses</span>
            <span class="t-it">Traccia analisi in coda e completate</span>
        </small>
    </div>
</div>

<div class="alert alert-info border-info mb-4" role="alert">
    <div class="d-flex align-items-start gap-2">
        <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
        <div>
            <strong class="t-en">How to Read This Table:</strong>
            <strong class="t-it">Come Leggere Questa Tabella:</strong>
            <ul class="small mb-0 mt-2">
                <li class="t-en"><strong>Status badges:</strong> üü¢ Success (green) = Job completed, üü° Queued (yellow) = Processing, üî¥ Failed (red) = Error occurred</li>
                <li class="t-en"><strong>Outputs:</strong> Click "View HTML" for interactive results or "Download CSV" for data</li>
                <li class="t-en"><strong>Thumbnail:</strong> Preview of molecular structure (if available)</li>
                <li class="t-en"><strong>View log:</strong> See technical details and any error messages</li>
                <li class="t-it"><strong>Badge Status:</strong> üü¢ Success (verde) = Job completato, üü° Queued (giallo) = In elaborazione, üî¥ Failed (rosso) = Errore</li>
                <li class="t-it"><strong>Outputs:</strong> Clicca "View HTML" per risultati interattivi o "Download CSV" per dati</li>
                <li class="t-it"><strong>Thumbnail:</strong> Anteprima struttura molecolare (se disponibile)</li>
                <li class="t-it"><strong>View log:</strong> Vedi dettagli tecnici e messaggi errore</li>
            </ul>
        </div>
    </div>
</div>

<div class="alert alert-warning border-warning" role="alert">
    <strong>‚ö†Ô∏è <span class="t-en">Clinical Decision Support Notice:</span><span class="t-it">Avviso Supporto Decisioni Cliniche:</span></strong>
    <span class="t-en">Results are provided for research and educational purposes only and must be reviewed alongside institutional guidelines before any clinical use.</span>
    <span class="t-it">I risultati sono forniti solo per scopi di ricerca ed educativi e devono essere revisionati secondo linee guida istituzionali prima di qualsiasi uso clinico.</span>
</div>

{% if jobs %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">
                                <span class="t-en">Created</span>
                                <span class="t-it">Creato</span>
                            </th>
                            <th scope="col">
                                <span class="t-en">Type</span>
                                <span class="t-it">Tipo</span>
                            </th>
                            <th scope="col">Status</th>
                            <th scope="col">
                                <span class="t-en">Requested By</span>
                                <span class="t-it">Richiesto Da</span>
                            </th>
                            <th scope="col">
                                <span class="t-en">Inputs</span>
                                <span class="t-it">Input</span>
                            </th>
                            <th scope="col">
                                <span class="t-en">Outputs</span>
                                <span class="t-it">Output</span>
                            </th>
                            <th scope="col">Thumbnail</th>
                            <th scope="col" class="text-end">
                                <span class="t-en">Actions</span>
                                <span class="t-it">Azioni</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                            {% with status=job.status_label %}
                            <tr data-job-id="{{ job.pk }}" data-job-status="{{ status.0 }}"{% if status.0 == "Queued" %} hx-get="{% url 'chemtools:job_status' job.pk %}" hx-trigger="load, every 5s" hx-target="this" hx-swap="none"{% endif %}>
                                <td>{{ job.created|date:"Y-m-d H:i" }}</td>
                                <td>{{ job.get_kind_display }}</td>
                                <td data-cell="status">
                                    {% if status.0 == "Queued" %}
                                        <div class="mb-1">
                                            <span class="badge bg-{{ status.1 }}">
                                                {{ status.0 }}
                                                <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
                                            </span>
                                        </div>
                                        <div class="progress" style="height: 8px; min-width: 120px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" 
                                                 style="width: {{ job.progress_percent }}%"
                                                 aria-valuenow="{{ job.progress_percent }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"
                                                 data-progress="{{ job.progress_percent }}">
                                            </div>
                                        </div>
                                        <small class="text-muted" data-progress-message>{{ job.progress_message|default:"Processing..." }}</small>
                                    {% else %}
                                        <span class="badge bg-{{ status.1 }}">{{ status.0 }}</span>
                                    {% endif %}
                                </td>
                                <td>{% if job.user %}{{ job.user.username }}{% else %}‚Äì{% endif %}</td>
                                <td>
                                    <div class="small text-muted">{{ job.input_a|default:"‚Äì" }}</div>
                                    {% if job.input_b %}<div class="small text-muted">{{ job.input_b }}</div>{% endif %}
                                </td>
                                <td data-cell="outputs">
                                    {% if job.out_html or job.out_csv %}
                                        <a href="{% url 'chemtools:job_detail' job.pk %}" class="btn btn-primary btn-sm">
                                            <span class="t-en">üìä View Results</span>
                                            <span class="t-it">üìä Vedi Risultati</span>
                                        </a>
                                    {% else %}
                                        <span class="text-muted small">
                                            <span class="t-en">No output yet</span>
                                            <span class="t-it">Nessun output</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td data-cell="thumbnail">
                                    {% if job.thumbnail_url %}
                                        <img src="{{ job.thumbnail_url }}" alt="thumbnail" class="img-thumbnail img-fluid" style="max-width: 96px;">
                                    {% else %}
                                        <span class="text-muted small">No preview</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#logModal{{ job.pk }}">
                                            View log
                                        </button>
                                        <a class="btn btn-outline-primary" href="{% url 'chemtools:job_retry' job.pk %}">Retry</a>
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% for job in jobs %}
        <div class="modal fade" id="logModal{{ job.pk }}" tabindex="-1" aria-labelledby="logModalLabel{{ job.pk }}" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logModalLabel{{ job.pk }}">Job Log ‚Äì {{ job.get_kind_display }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <pre class="small mb-0">{{ job.log|default:"(no log)" }}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary" role="alert">
        <div class="text-center py-4">
            <div style="font-size: 3rem;" class="mb-3">üì≠</div>
            <h3 class="h5">
                <span class="t-en">No Jobs Yet</span>
                <span class="t-it">Nessun Job Ancora</span>
            </h3>
            <p class="text-muted mb-3">
                <span class="t-en">You haven't submitted any analysis jobs yet. Get started by choosing a tool above!</span>
                <span class="t-it">Non hai ancora inviato job di analisi. Inizia scegliendo uno strumento sopra!</span>
            </p>
            <div class="d-flex gap-2 justify-content-center">
                <a href="{% url 'chemtools:drug_params' %}" class="btn btn-primary">
                    <span class="t-en">Try Drug Parameters</span>
                    <span class="t-it">Prova Parametri Farmaci</span>
                </a>
                <a href="{% url 'chemtools:similarity' %}" class="btn btn-info">
                    <span class="t-en">Try Similarity Search</span>
                    <span class="t-it">Prova Ricerca Similarit√†</span>
                </a>
            </div>
        </div>
    </div>
{% endif %}

<style>
.hover-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.hover-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2) !important;
}
</style>

{% block extra_js %}
{{ block.super }}
<script>
(() => {
    const buildOutputs = (data, jobId) => {
        if (!data.has_html && !data.has_csv) {
            return '<span class="text-muted small"><span class="t-en">No output yet</span><span class="t-it">Nessun output</span></span>';
        }
        return `<a href="/chemtools/job/${jobId}/" class="btn btn-primary btn-sm"><span class="t-en">üìä View Results</span><span class="t-it">üìä Vedi Risultati</span></a>`;
    };

    document.body.addEventListener('htmx:afterRequest', (event) => {
        const detail = event.detail;
        if (!detail || detail.mmMatchedPath !== 'chemtools') {
            return;
        }
        const targetEl = detail.target || event.target;
        const row = targetEl ? targetEl.closest('tr[data-job-id]') : null;
        if (!row) {
            return;
        }
        const data = detail.mmParsedJson;
        if (!data) {
            return;
        }
        
        // Update status badge and progress bar
        const statusCell = row.querySelector('[data-cell="status"]');
        if (statusCell) {
            if (data.status === 'Queued') {
                const progressPercent = data.progress_percent || 0;
                const progressMessage = data.progress_message || 'Processing...';
                statusCell.innerHTML = `
                    <div class="mb-1">
                        <span class="badge bg-${data.variant}">
                            ${data.status}
                            <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
                        </span>
                    </div>
                    <div class="progress" style="height: 8px; min-width: 120px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: ${progressPercent}%"
                             aria-valuenow="${progressPercent}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             data-progress="${progressPercent}">
                        </div>
                    </div>
                    <small class="text-muted" data-progress-message>${progressMessage}</small>
                `;
            } else {
                statusCell.innerHTML = `<span class="badge bg-${data.variant}">${data.status}</span>`;
            }
        }
        
        const outputsCell = row.querySelector('[data-cell="outputs"]');
        if (outputsCell) {
            const jobId = row.dataset.jobId;
            outputsCell.innerHTML = buildOutputs(data, jobId);
        }
        const thumbCell = row.querySelector('[data-cell="thumbnail"]');
        if (thumbCell) {
            thumbCell.innerHTML = data.thumbnail_url
                ? `<img src="${data.thumbnail_url}" alt="thumbnail" class="img-thumbnail" style="max-width: 96px;">`
                : '<span class="text-muted small">No preview</span>';
        }
        row.dataset.jobStatus = data.status;
        if (data.status !== 'Queued') {
            row.removeAttribute('hx-trigger');
        }
    });
})();
</script>
{% endblock %}
{% endblock %}
